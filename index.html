<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Tajawal:wght@400;700;900&display=swap');
        :root {
            --primary-gradient: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
            --admin-gradient: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            --user-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --alert-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            --success-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
            --bg-color: #f4f8fb;
            --card-bg: #fff;
            --text-color: #1a2236;
            --text-secondary: #5a6a85;
            --border-color: #cfd8dc;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.13);
            --hover-shadow: 0 16px 32px 0 rgba(67, 206, 162, 0.18);
            --accent: #185a9d;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #17a2b8;
            --checkin-color: #28a745;
            --checkout-color: #dc3545;
        }

        [data-theme="dark"] {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #f0f6fc;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.4);
            --hover-shadow: 0 16px 32px 0 rgba(67, 206, 162, 0.3);
            --accent: #58a6ff;
            --success: #3fb950;
            --danger: #f85149;
            --warning: #d29922;
            --info: #79c0ff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 0.97rem;
            line-height: 1.7;
            transition: all 0.3s ease;
        }

        /* Enhanced Notification System */
        .notifications {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 2000;
            max-width: 420px;
        }

        .notification {
            color: white;
            padding: 18px 24px;
            border-radius: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
            font-size: 0.97em;
            border-left: 5px solid rgba(255,255,255,0.3);
        }

        .notification.success { background: var(--success-gradient); color: #155724; }
        .notification.warning { background: var(--warning-gradient); color: #856404; }
        .notification.info { background: var(--primary-gradient); }
        .notification.error { background: var(--alert-gradient); color: #721c24; }

        /* Enhanced Login Card */
        .login-card {
            background: var(--card-bg);
            padding: 48px 36px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 2px solid var(--border-color);
        }

        .login-card h1 {
            color: var(--accent);
            margin-bottom: 32px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--accent);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(67, 206, 162, 0.07);
            font-size: 0.97em;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 206, 162, 0.13);
            background: var(--card-bg);
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(67, 206, 162, 0.13);
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: var(--hover-shadow);
            background: var(--accent);
        }

        .btn-small {
            padding: 8px 18px;
            font-size: 13px;
            width: auto;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .btn-admin {
            background: var(--admin-gradient);
        }

        .btn-user {
            background: var(--user-gradient);
        }

        /* Dashboard Layout */
        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 24px 18px;
        }

        .top-bar {
            background: var(--card-bg);
            padding: 24px 36px;
            border-radius: 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section h1 {
            color: var(--accent);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .user-badge {
            padding: 8px 14px;
            border-radius: 18px;
            font-size: 0.97em;
            font-weight: bold;
            color: white;
            background: var(--accent);
            box-shadow: 0 2px 8px rgba(67, 206, 162, 0.13);
        }

        .user-badge.admin {
            background: var(--admin-gradient);
        }

        .user-badge.user {
            background: var(--user-gradient);
        }

        .theme-toggle {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(67, 206, 162, 0.13);
        }

        .theme-toggle:hover {
            transform: scale(1.12);
            background: var(--accent);
        }

        /* Enhanced Stats Grid with Center Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: #fff;
            padding: 36px 28px;
            border-radius: 22px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-7px) scale(1.04);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent);
        }

        .stat-card.checkin-stat {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .stat-card.checkout-stat {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .stat-number {
            font-size: 1.7em;
            font-weight: bold;
            margin-bottom: 12px;
            display: block;
            letter-spacing: 1px;
            color: #fff;
        }

        .stat-label {
            font-size: 0.97em;
            opacity: 0.97;
            color: #fff;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 370px 1fr;
            gap: 24px;
            margin-bottom: 24px;
            position: relative;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 22px;
            padding: 36px 28px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            min-width: 340px;
            max-width: 370px;
            transition: all 0.3s;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Enhanced Map Container */
        .map-container {
            background: var(--card-bg);
            border-radius: 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 24px;
            position: relative;
        }

        .map-header {
            padding: 20px 24px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .map-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .map-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 206, 162, 0.3);
        }

        .map-btn.style-toggle {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        #map {
            height: 550px;
            border-radius: 0 0 20px 20px;
        }

        /* Enhanced Data Sections */
        .data-section {
            background: var(--card-bg);
            border-radius: 22px;
            padding: 36px 28px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 28px;
            color: var(--text-color);
        }

        .section-title {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Enhanced search for employee movements */
        .movement-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .movement-search input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        /* Sidebar sections */
        .sidebar-section {
            margin-bottom: 24px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-header {
            background: var(--primary-gradient);
            color: #fff;
            border-bottom: 1px solid var(--border-color);
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.97em;
            transition: all 0.3s;
        }

        .section-header:hover {
            background: var(--accent);
        }

        .section-header .toggle-icon {
            font-size: 1.3em;
            transition: transform 0.3s;
        }

        .section-header.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 24px;
            background: var(--card-bg);
            max-height: 1000px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 24px;
        }

        .section-tip {
            background: var(--info);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-size: 1em;
        }

        .permission-warning {
            background: var(--warning);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-size: 1em;
            border-left: 4px solid #ffc107;
        }

        /* Enhanced Location Display for 10k+ employees */
        .location-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent);
        }

        .employee-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
        }

        .employee-status.active {
            background: var(--success);
            color: white;
        }

        .employee-status.inactive {
            background: var(--danger);
            color: white;
        }

        .employee-status.moving {
            background: var(--warning);
            color: white;
            animation: pulse 2s infinite;
        }

        /* Pagination for large datasets */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover {
            background: var(--accent);
            color: white;
        }

        .pagination button.active {
            background: var(--accent);
            color: white;
        }

        /* Virtual scrolling container for performance */
        .virtual-list {
            height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
        }

        /* Enhanced Logs with better color coding */
        .logs-container {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            padding: 18px;
            background: var(--card-bg);
        }

        .log-entry {
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-size: 0.95em;
            border-right: 5px solid;
            position: relative;
            transition: all 0.3s;
        }

        .log-entry:hover {
            transform: translateX(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .log-entry.checkin, .log-entry.auto_checkin, .log-entry.in, .log-entry.center_entry {
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            color: var(--checkin-color);
            border-right-color: var(--checkin-color);
        }

        .log-entry.checkout, .log-entry.auto_checkout, .log-entry.out {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
            color: var(--checkout-color);
            border-right-color: var(--checkout-color);
        }

        .log-entry.center_nearby, .log-entry.movement {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            color: var(--warning);
            border-right-color: var(--warning);
        }

        .log-entry.location_update {
            background: linear-gradient(90deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
            color: var(--text-secondary);
            border-right-color: var(--text-secondary);
        }

        .log-meta {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        /* Search Section */
        .search-section {
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.97em;
        }

        .locate-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 0.97em;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .locate-btn:hover {
            background: #219150;
            transform: translateY(-1px);
        }

        /* Enhanced Item Cards for performance */
        .item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 16px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            border-left: 5px solid var(--accent);
            box-shadow: var(--shadow);
            transition: all 0.25s;
            border: 1px solid var(--border-color);
        }

        .item-card:hover {
            transform: translateX(-4px) scale(1.01);
            box-shadow: var(--hover-shadow);
            border-left-color: var(--accent);
        }

        .item-info {
            flex: 1;
        }

        .item-info strong {
            color: var(--accent);
            font-size: 1.1em;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Center statistics on map markers */
        .marker-popup {
            font-family: 'Cairo', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }

        .center-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
            padding: 5px;
        }

        .stat-item.checkin-stat {
            color: var(--checkin-color);
        }

        .stat-item.checkout-stat {
            color: var(--checkout-color);
        }

        /* Connection Status */
        .connection-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .connection-indicator.offline {
            background: var(--warning);
            color: #000;
        }

        .connection-indicator.error {
            background: var(--danger);
        }

        /* Auto refresh indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background: var(--info);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-indicator.visible {
            opacity: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 36px;
            border-radius: 18px;
            width: 92%;
            max-width: 540px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .close {
            color: var(--text-secondary);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent);
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::before {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .search-section {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .map-controls {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 18px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .notifications {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .map-controls {
                flex-direction: column;
                gap: 5px;
            }

            .item-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .section-title {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Notifications Container -->
    <div class="notifications" id="notifications"></div>

    <!-- Connection Status Indicator -->
    <div class="connection-indicator" id="connectionIndicator">
        ğŸŸ¢ Ù…ØªØµÙ„
    </div>

    <!-- Auto Refresh Indicator -->
    <div class="refresh-indicator" id="refreshIndicator">
        ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen" style="display: flex; min-height: 100vh; align-items: center; justify-content: center;">
        <div class="login-card">
            <h1>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - ÙŠØ¯Ø¹Ù… 10000+ ÙØ±Ø¯</p>
            
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="loginUsername" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            </div>
            
            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            
            <button class="btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--info); color: white; border-radius: 10px; font-size: 0.9em;">
                <strong>Ø­Ø³Ø§Ø¨Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©:</strong><br>
                Ù…Ø¯ÙŠØ±: admin / admin123<br>
                Ù…Ø³ØªØ®Ø¯Ù…: user1 / user123
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container" id="dashboard" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo-section">
                <h1>ğŸ›ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…  </h1>
                <p style="color: var(--text-secondary);"><span style="color: var(--success);">â—</span> Ù…Ø¨Ø§Ø´Ø± - ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©</p>
            </div>
            
            <div class="user-section">
                <div class="user-badge" id="userRoleBadge">Ù…Ø³ØªØ®Ø¯Ù…</div>
                <span id="welcomeMessage">Ù…Ø±Ø­Ø¨Ø§Ù‹</span>
                <button class="theme-toggle" onclick="toggleTheme()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ù…Ø©">ğŸŒ™</button>
                <button class="btn btn-danger btn-small" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <!-- Enhanced Statistics Dashboard with Center Statistics -->
        <div class="stats-grid">
            <div class="stat-card" onclick="focusOnEmployees()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                <span class="stat-number" id="totalEmployees">0</span>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙØ±Ø§Ø¯</div>
            </div>
            <div class="stat-card" onclick="focusOnActiveEmployees()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†">
                <span class="stat-number" id="activeEmployees">0</span>
                <div class="stat-label">Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</div>
            </div>
            <div class="stat-card checkin-stat" onclick="focusOnCheckedIn()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø¶ÙˆØ±Ù‡Ù…">
                <span class="stat-number" id="checkedInEmployees">0</span>
                <div class="stat-label">Ù…Ø³Ø¬Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            <div class="stat-card checkout-stat" onclick="focusOnCheckedOut()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù†ØµØ±Ø§ÙÙ‡Ù…">
                <span class="stat-number" id="checkedOutEmployees">0</span>
                <div class="stat-label">Ù…Ø³Ø¬Ù„ÙŠ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            <div class="stat-card" onclick="focusOnCenters()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø§ÙƒØ²">
                <span class="stat-number" id="totalCenters">0</span>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</div>
            </div>
            <div class="stat-card" onclick="focusOnLogs()" title="Ø§Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª">
                <span class="stat-number" id="todayLogs">0</span>
                <div class="stat-label">Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </div>

        <!-- Enhanced Search Section -->
        <div class="search-section">
            <input type="text" class="search-input" id="searchEmployees" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¯..." oninput="filterEmployees()">
            <input type="text" class="search-input" id="searchCenters" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙƒØ²..." oninput="filterCenters()">
            <button class="locate-btn" onclick="locateMe()" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
            <button class="locate-btn" onclick="refreshAll()" title="ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <!-- Main Layout with Sidebar -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Add Center Section -->
                <div class="sidebar-section" id="addCenterSection">
                    <div class="section-header" onclick="toggleSection('centerSection')">
                        <span>ğŸ¢ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ² Ø¬Ø¯ÙŠØ¯</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="section-content collapsed" id="centerSection">
                        <div class="section-tip">
                            ğŸ’¡ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        </div>
                        
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²</label>
                            <input type="text" id="centerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²">
                        </div>
                        <div class="form-group">
                            <label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label>
                            <input type="number" id="centerLng" step="any" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="form-group">
                            <label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
                            <input type="number" id="centerLat" step="any" placeholder="Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                        </div>
                        <div class="form-group">
                            <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø±ÙƒØ² (Ù…ØªØ±)</label>
                            <input type="number" id="centerRadius" value="100" placeholder="100">
                        </div>
                        <button class="btn" onclick="addCenter()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙƒØ²</button>
                    </div>
                </div>

                <!-- Add Employee Section -->
                <div class="sidebar-section" id="addEmployeeSection">
                    <div class="section-header" onclick="toggleSection('employeeSection')">
                        <span>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="section-content collapsed" id="employeeSection">
                        <div class="permission-warning" id="employeePermissionWarning" style="display: none;">
                            âš ï¸ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙØ±Ø§Ø¯ ÙÙŠ Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø© Ù„Ùƒ ÙÙ‚Ø·
                        </div>
                        
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯</label>
                            <input type="text" id="employeeName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯">
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" id="employeePhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                        </div>
                        <div class="form-group">
                            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="employeePassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ù†ØµØ¨</label>
                            <input type="text" id="employeePosition" placeholder="Ø§Ù„Ù…Ù†ØµØ¨/Ø§Ù„ÙˆØ¸ÙŠÙØ©">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø®ØµØµ</label>
                            <select id="employeeCenter">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addEmployee()">Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯</button>
                    </div>
                </div>

                <!-- Add User Section (Admin Only) -->
                <div class="sidebar-section" id="addUserSection" style="display: none;">
                    <div class="section-header" onclick="toggleSection('userSection')">
                        <span>ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</span>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="section-content collapsed" id="userSection">
                        <div class="section-tip">
                            ğŸ‘¨â€ğŸ’¼ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
                        </div>
                        
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input type="text" id="newUsername" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                            <input type="text" id="newUserFullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                        </div>
                        <div class="form-group">
                            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                            <input type="password" id="newUserPassword" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© (6+ Ø£Ø­Ø±Ù)">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="newUserEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" id="newUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                        <div class="form-group">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <select id="newUserRole">
                                <option value="user">Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addUser()">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Enhanced Map Section with Center Statistics -->
                <div class="map-container">
                    <div class="map-header">
                        <h2 style="color: var(--text-color); margin: 0;">ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                        <div class="map-controls">
                            <button class="map-btn" onclick="refreshMap()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                            <button class="map-btn" onclick="fitAllMarkers()" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙƒØ²">ğŸ¢ Ø§Ù„Ù…Ø±Ø§ÙƒØ²</button>
                            <button class="map-btn" onclick="showAllEmployeesOnMap()" title="Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙØ±Ø§Ø¯">ğŸ‘¥ Ø§Ù„Ø£ÙØ±Ø§Ø¯</button>
                            <button class="map-btn style-toggle" onclick="toggleMapStyle()" title="ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ—ºï¸ Ø§Ù„Ù†Ù…Ø·</button>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>

                <!-- Enhanced Employee Locations with Search -->
                <div class="data-section">
                    <div class="section-title">
                        <span>ğŸ“ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙˆØ§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" onclick="refreshEmployeeLocations()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                    </div>
                    
                    <!-- Enhanced search for movements -->
                    <div class="movement-search">
                        <input type="text" id="searchMovements" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¨Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯..." oninput="filterMovements()">
                        <button class="btn btn-small" onclick="clearMovementSearch()">Ù…Ø³Ø­</button>
                    </div>
                    
                    <div class="virtual-list" id="employeeLocations">
                        <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹...</div>
                    </div>
                    
                    <!-- Pagination for large datasets -->
                    <div class="pagination" id="locationsPagination" style="display: none;">
                        <button onclick="previousPage('locations')">â† Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <span id="locationsPageInfo">ØµÙØ­Ø© 1 Ù…Ù† 1</span>
                        <button onclick="nextPage('locations')">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
                    </div>
                </div>

                <!-- Enhanced Data Display with Pagination -->
                <div class="data-section">
                    <h2 class="section-title">ğŸ“Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                            <div class="virtual-list" id="centersList"></div>
                        </div>
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯</h3>
                            <div class="virtual-list" id="employeesList"></div>
                            <div class="pagination" id="employeesPagination" style="display: none;">
                                <button onclick="previousPage('employees')">â† Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                                <span id="employeesPageInfo">ØµÙØ­Ø© 1 Ù…Ù† 1</span>
                                <button onclick="nextPage('employees')">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Activity Logs with Color Coding and Search -->
                <div class="data-section">
                    <div class="section-title">
                        <span>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„</span>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="logFilter" onchange="filterLogs()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color);">
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</option>
                                <option value="checkin">Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·</option>
                                <option value="checkout">Ø®Ø±ÙˆØ¬ ÙÙ‚Ø·</option>
                                <option value="movement">Ø­Ø±ÙƒØ§Øª ÙÙ‚Ø·</option>
                                <option value="center_entry">Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø§ÙƒØ²</option>
                            </select>
                            <button class="btn btn-small" onclick="refreshLogs()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                    </div>
                    
                    <div class="logs-container" id="activityLogs">
                        <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</div>
                    </div>
                    
                    <div class="pagination" id="logsPagination" style="display: none;">
                        <button onclick="previousPage('logs')">â† Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                        <span id="logsPageInfo">ØµÙØ­Ø© 1 Ù…Ù† 1</span>
                        <button onclick="nextPage('logs')">Ø§Ù„ØªØ§Ù„ÙŠ â†’</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯</h2>
                <span class="close" onclick="closeModal('editEmployeeModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¯</label>
                <input type="text" id="editEmployeeName">
            </div>
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input type="text" id="editEmployeePhone">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ù†ØµØ¨</label>
                <input type="text" id="editEmployeePosition">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø±ÙƒØ²</label>
                <select id="editEmployeeCenter"></select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <select id="editEmployeeStatus">
                    <option value="active">Ù†Ø´Ø·</option>
                    <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                </select>
            </div>
            <button class="btn" onclick="updateEmployee()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <!-- Edit Center Modal -->
    <div id="editCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²</h2>
                <span class="close" onclick="closeModal('editCenterModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²</label>
                <input type="text" id="editCenterName">
            </div>
            <div class="form-group">
                <label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„</label>
                <input type="number" id="editCenterLng" step="any">
            </div>
            <div class="form-group">
                <label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶</label>
                <input type="number" id="editCenterLat" step="any">
            </div>
            <div class="form-group">
                <label>Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø±ÙƒØ² (Ù…ØªØ±)</label>
                <input type="number" id="editCenterRadius">
            </div>
            <button class="btn" onclick="updateCenter()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <script>
        // Global Variables
        let supabase;
        let map;
        let currentUser = null;
        let userPermissions = null;
        let allowedCenters = [];
        let allowedEmployees = [];
        let allCenters = [];
        let allEmployees = [];
        let allLogs = [];
        let centerStats = {};
        let currentEditingEmployee = null;
        let currentEditingCenter = null;
        let myLocationMarker = null;
        let currentMapStyle = 'streets-v12';
        let autoRefreshInterval = null;

        // Pagination states
        let paginationState = {
            employees: { currentPage: 1, pageSize: 50, totalPages: 1 },
            locations: { currentPage: 1, pageSize: 20, totalPages: 1 },
            logs: { currentPage: 1, pageSize: 50, totalPages: 1 }
        };

        // Session Management
        let sessionData = {
            isLoggedIn: false,
            user: null,
            loginTime: null
        };

        // Supabase Configuration
        const supabaseUrl = 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';

        // Mapbox Configuration
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW1lZXI3ZWx3YXMiLCJhIjoiY21iODAxaTFyMGFsajJqc2J2dGtvY2pmdSJ9.MNY-7y2onlfAnM0PUhNt8g';

        // Map styles for toggle
        const mapStyles = [
            'mapbox://styles/mapbox/streets-v12',
            'mapbox://styles/mapbox/satellite-v9',
            'mapbox://styles/mapbox/light-v11',
            'mapbox://styles/mapbox/dark-v11'
        ];
        let currentStyleIndex = 0;

        // Timestamp Functions (Iraq timezone)
        function getCurrentTimestamp() {
            return new Date().toISOString();
        }

        function formatLocalDateTime(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            try {
                const date = new Date(timestamp);
                const options = {
                    year: 'numeric',
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Baghdad',
                    hour12: true
                };
                
                let formatted = date.toLocaleString('ar-IQ', options);
                formatted = formatted.replace(/AM/g, 'Øµ').replace(/PM/g, 'Ù…');
                return formatted;
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ§Ù„Ø­';
            }
        }

        function getTimeDifference(timestamp) {
            if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            try {
                const now = new Date();
                const time = new Date(timestamp);
                const diffInSeconds = Math.floor((now - time) / 1000);
                
                if (diffInSeconds < 30) return 'Ø§Ù„Ø¢Ù†';
                if (diffInSeconds < 60) return 'Ù…Ù†Ø° Ù„Ø­Ø¸Ø§Øª';
                if (diffInSeconds < 3600) return `Ù…Ù†Ø° ${Math.floor(diffInSeconds / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
                if (diffInSeconds < 86400) return `Ù…Ù†Ø° ${Math.floor(diffInSeconds / 3600)} Ø³Ø§Ø¹Ø©`;
                return `Ù…Ù†Ø° ${Math.floor(diffInSeconds / 86400)} ÙŠÙˆÙ…`;
            } catch (error) {
                console.error('Error calculating time difference:', error);
                return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            }
        }

        function getTodayDateStart() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today.toISOString();
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Enhanced application v2 starting...');
            
            // Initialize section states
            initializeSections();
            
            // Check saved session
            const savedSession = localStorage.getItem('sessionData');
            if (savedSession) {
                try {
                    const parsed = JSON.parse(savedSession);
                    if (parsed.isLoggedIn && parsed.user) {
                        sessionData = parsed;
                        currentUser = parsed.user;
                        userPermissions = parsed.user.permissions;
                        showDashboard();
                    }
                } catch(e) {}
            }

            try {
                await initializeSupabase();
                updateConnectionStatus('Ù…ØªØµÙ„', 'normal');
                console.log('System loaded successfully');
            } catch (error) {
                console.error('System loading error:', error);
                updateConnectionStatus('Ø®Ø·Ø£ Ø§ØªØµØ§Ù„', 'error');
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…: ' + error.message, 'error');
            }
        });

        // Initialize Section States
        function initializeSections() {
            const centerSection = document.getElementById('centerSection');
            const employeeSection = document.getElementById('employeeSection');
            const userSection = document.getElementById('userSection');
            
            if (centerSection) {
                centerSection.classList.add('collapsed');
                centerSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }
            
            if (employeeSection) {
                employeeSection.classList.add('collapsed');
                employeeSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }

            if (userSection) {
                userSection.classList.add('collapsed');
                userSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }
        }

        // Toggle Section Visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.parentElement.querySelector('.section-header');
            
            section.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // Initialize Supabase
        function initializeSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function checkSupabase() {
                    attempts++;
                    if (window.supabase) {
                        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase initialized successfully');
                        resolve(supabase);
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkSupabase, 200);
                    } else {
                        reject(new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'));
                    }
                }
                checkSupabase();
            });
        }

        // Enhanced Notification System
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.remove();
                }, duration);
            }

            return notification;
        }

        // Enhanced Connection Status
        function updateConnectionStatus(message, type = 'normal') {
            const indicator = document.getElementById('connectionIndicator');
            if (indicator) {
                const icons = {
                    normal: 'ğŸŸ¢',
                    offline: 'ğŸŸ¡',
                    error: 'ğŸ”´',
                    syncing: 'ğŸ”„'
                };
                
                indicator.textContent = `${icons[type]} ${message}`;
                indicator.className = `connection-indicator ${type}`;
            }
        }

        // Auto refresh indicator
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // Authentication Functions
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
                return;
            }

            try {
                const { data, error } = await supabase.rpc('authenticate_user', {
                    user_username: username,
                    user_password: password
                });

                if (error) throw error;

                const result = data;
                if (result.success) {
                    sessionData = {
                        isLoggedIn: true,
                        user: result.user,
                        loginTime: getCurrentTimestamp()
                    };
                    
                    currentUser = result.user;
                    userPermissions = result.user.permissions;
                    localStorage.setItem('sessionData', JSON.stringify(sessionData));
                    
                    showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
                    setTimeout(() => {
                        showDashboard();
                    }, 1000);
                } else {
                    showNotification('âŒ ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
            }
        }

        function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                // Clear auto refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }

                sessionData = { isLoggedIn: false, user: null, loginTime: null };
                currentUser = null;
                userPermissions = null;
                allowedCenters = [];
                allowedEmployees = [];
                localStorage.removeItem('sessionData');
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
            }
        }

        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            updateUIForUser();
            
            setTimeout(() => {
                initializeMap();
                setTimeout(() => {
                    loadAllData();
                    setupRealTimeUpdates();
                    startAutoRefresh();
                }, 1000);
            }, 500);
        }

        function updateUIForUser() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            const userRoleBadge = document.getElementById('userRoleBadge');
            
            welcomeMsg.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.full_name}`;
            
            if (currentUser.role === 'admin') {
                userRoleBadge.textContent = 'ğŸ‘¨â€ğŸ’¼ Ù…Ø¯ÙŠØ±';
                userRoleBadge.className = 'user-badge admin';
            } else {
                userRoleBadge.textContent = 'ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù…';
                userRoleBadge.className = 'user-badge user';
            }
            
            updateSectionsVisibility();
        }

        function updateSectionsVisibility() {
            const addCenterSection = document.getElementById('addCenterSection');
            const addEmployeeSection = document.getElementById('addEmployeeSection');
            const addUserSection = document.getElementById('addUserSection');
            const employeePermissionWarning = document.getElementById('employeePermissionWarning');
            
            if (!userPermissions.can_add_centers) {
                addCenterSection.style.display = 'none';
            }
            
            if (!userPermissions.can_add_employees) {
                addEmployeeSection.style.display = 'none';
            } else if (currentUser.role !== 'admin') {
                employeePermissionWarning.style.display = 'block';
            }

            if (currentUser.role === 'admin') {
                addUserSection.style.display = 'block';
            }
        }

        // Auto refresh every 30 seconds
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            autoRefreshInterval = setInterval(async () => {
                if (sessionData.isLoggedIn) {
                    try {
                        showRefreshIndicator();
                        await updateStats();
                        await refreshEmployeeLocations();
                        updateTimeDifferences();
                    } catch (error) {
                        console.error('Auto refresh error:', error);
                    }
                }
            }, 30000); // 30 seconds
        }

        function updateTimeDifferences() {
            document.querySelectorAll('.time-ago').forEach(element => {
                const timestamp = element.getAttribute('data-timestamp');
                if (timestamp) {
                    element.textContent = getTimeDifference(timestamp);
                }
            });
        }

        // Enhanced Map Functions
        function initializeMap() {
            mapboxgl.setRTLTextPlugin(
                'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js',
                null,
                true
            );

            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: mapStyles[currentStyleIndex],
                    center: [44.3661, 32.6155], // Karbala coordinates
                    zoom: 12,
                    locale: 'ar'
                });

                map.addControl(new mapboxgl.NavigationControl(), 'top-left');

                if (userPermissions && userPermissions.can_add_centers) {
                    map.on('click', function(e) {
                        const coordinates = e.lngLat;
                        document.getElementById('centerLng').value = coordinates.lng.toFixed(6);
                        document.getElementById('centerLat').value = coordinates.lat.toFixed(6);
                        
                        showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}`, 'success');
                    });
                }

                map.on('load', function() {
                    console.log('Enhanced map loaded successfully');
                    updateMapMarkers();
                });

            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'error');
            }
        }

        // Toggle map style
        function toggleMapStyle() {
            if (!map) return;
            
            currentStyleIndex = (currentStyleIndex + 1) % mapStyles.length;
            map.setStyle(mapStyles[currentStyleIndex]);
            
            const styleNames = ['Ø§Ù„Ø´ÙˆØ§Ø±Ø¹', 'Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©', 'ÙØ§ØªØ­', 'Ù…Ø¸Ù„Ù…'];
            showNotification(`ØªÙ… ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰: ${styleNames[currentStyleIndex]}`, 'info', 2000);
            
            // Re-add markers after style change
            map.once('styledata', () => {
                setTimeout(() => {
                    updateMapMarkers();
                    updateMapWithEmployees();
                }, 1000);
            });
        }

        // Show all employees on map
        async function showAllEmployeesOnMap() {
            if (!map) {
                showNotification('Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© Ø¨Ø¹Ø¯', 'warning');
                return;
            }

            try {
                let employeeIds = [];
                
                if (currentUser.role === 'admin') {
                    const { data: allEmps } = await supabase.from('employees').select('id');
                    employeeIds = allEmps ? allEmps.map(emp => emp.id) : [];
                } else {
                    employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                }

                if (employeeIds.length === 0) {
                    showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ Ù„Ø¹Ø±Ø¶Ù‡Ù…', 'warning');
                    return;
                }

                const { data: latestLogs, error } = await supabase
                    .from('logs')
                    .select(`*, employees (id, name, status, phone)`)
                    .in('employee_id', employeeIds)
                    .not('latitude', 'is', null)
                    .not('longitude', 'is', null)
                    .order('occurred_at', { ascending: false });

                if (error) throw error;

                // Group by employee and get latest location
                const employeeLocations = {};
                latestLogs.forEach(log => {
                    if (log.employees && !employeeLocations[log.employees.id]) {
                        employeeLocations[log.employees.id] = {
                            employee: log.employees,
                            location: {
                                latitude: log.latitude,
                                longitude: log.longitude,
                                action: log.action,
                                time: log.occurred_at || log.created_at
                            }
                        };
                    }
                });

                updateMapWithEmployees(employeeLocations);
                
                // Fit map to show all employees
                if (Object.keys(employeeLocations).length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    Object.values(employeeLocations).forEach(empData => {
                        bounds.extend([empData.location.longitude, empData.location.latitude]);
                    });
                    map.fitBounds(bounds, { padding: 50 });
                }

                showNotification(`ØªÙ… Ø¹Ø±Ø¶ ${Object.keys(employeeLocations).length} ÙØ±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©`, 'success');
            } catch (error) {
                console.error('Error showing employees on map:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'error');
            }
        }

        // Locate Me Function - FIXED
        function locateMe() {
            if (!map) {
                showNotification('Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹...', 'warning');
                return;
            }

            if (navigator.geolocation) {
                showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const { latitude, longitude } = position.coords;
                        
                        // Remove previous marker if exists
                        if (myLocationMarker) {
                            myLocationMarker.remove();
                        }
                        
                        // Fly to location
                        map.flyTo({
                            center: [longitude, latitude],
                            zoom: 16,
                            duration: 2000
                        });

                        // Add marker for my location
                        myLocationMarker = new mapboxgl.Marker({ 
                            color: '#ff6b6b',
                            scale: 1.2
                        })
                            .setLngLat([longitude, latitude])
                            .setPopup(new mapboxgl.Popup({ 
                                className: 'arabic-popup',
                                offset: 25
                            }).setHTML(`
                                <div class="marker-popup">
                                    <strong>ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</strong><br>
                                    <small>Ø¯Ù‚Ø©: ${Math.round(position.coords.accuracy)}Ù…</small>
                                </div>
                            `))
                            .addTo(map);

                        showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ“', 'success');
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        let errorMessage = 'ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.';
                                break;
                            default:
                                errorMessage += 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.';
                                break;
                        }
                        
                        showNotification(errorMessage, 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                showNotification('Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'error');
            }
        }

        // Map control functions
        function refreshMap() {
            if (map) {
                updateMapMarkers();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'success', 2000);
            }
        }

        function fitAllMarkers() {
            if (map && allowedCenters.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                allowedCenters.forEach(center => {
                    bounds.extend([center.longitude, center.latitude]);
                });
                map.fitBounds(bounds, { padding: 50 });
                showNotification('ØªÙ… Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§ÙƒØ²', 'info', 2000);
            }
        }

        // Data Loading Functions - ENHANCED
        async function loadAllData() {
            try {
                updateConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...', 'syncing');
                
                if (currentUser.role === 'admin') {
                    await Promise.all([
                        loadCenters(),
                        loadEmployees(),
                        loadLogs(),
                        loadCenterStats(),
                        updateStats(),
                        refreshEmployeeLocations()
                    ]);
                    
                    allowedCenters = [...allCenters];
                    allowedEmployees = [...allEmployees];
                } else {
                    await Promise.all([
                        loadAllowedCenters(),
                        loadAllowedEmployees(),
                        loadLogs(),
                        loadCenterStats(),
                        updateStats(),
                        refreshEmployeeLocations()
                    ]);
                }
                
                if (map && map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                
                updateConnectionStatus('Ù…ØªØµÙ„', 'normal');
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateConnectionStatus('Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„', 'error');
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // Load center statistics
        async function loadCenterStats() {
            try {
                const todayStart = getTodayDateStart();
                
                // Get checkin/checkout stats for each center
                let query = supabase
                    .from('logs')
                    .select('center_id, action')
                    .gte('occurred_at', todayStart);

                if (currentUser.role !== 'admin' && allowedEmployees.length > 0) {
                    const employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                    query = query.in('employee_id', employeeIds);
                }

                const { data: logs, error } = await query;
                if (error) throw error;

                // Process statistics
                centerStats = {};
                logs.forEach(log => {
                    if (!centerStats[log.center_id]) {
                        centerStats[log.center_id] = { checkins: 0, checkouts: 0 };
                    }
                    
                    if (log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry') {
                        centerStats[log.center_id].checkins++;
                    } else if (log.action.includes('checkout') || log.action === 'out') {
                        centerStats[log.center_id].checkouts++;
                    }
                });

                console.log('Center stats loaded:', centerStats);
            } catch (error) {
                console.error('Error loading center stats:', error);
                centerStats = {};
            }
        }

        async function loadAllowedCenters() {
            try {
                const { data: centers, error } = await supabase.rpc('get_user_allowed_centers', {
                    input_user_id: currentUser.id
                });

                if (error) throw error;

                allowedCenters = centers || [];
                displayCenters(allowedCenters);
            } catch (error) {
                console.error('Error loading allowed centers:', error);
            }
        }

        async function loadAllowedEmployees() {
            try {
                const { data: employees, error } = await supabase.rpc('get_user_allowed_employees', {
                    input_user_id: currentUser.id
                });

                if (error) throw error;

                allowedEmployees = employees || [];
                displayEmployees(allowedEmployees);
            } catch (error) {
                console.error('Error loading allowed employees:', error);
            }
        }

        async function loadCenters() {
            try {
                const { data: centers, error } = await supabase
                    .from('centers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allCenters = centers || [];
                displayCenters(allCenters);
            } catch (error) {
                console.error('Error loading centers:', error);
            }
        }

        async function loadEmployees() {
            try {
                const { data: employees, error } = await supabase
                    .from('employees')
                    .select(`*, centers (name)`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allEmployees = employees || [];
                displayEmployees(allEmployees);
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Display Functions with Pagination - ENHANCED
        function displayCenters(centers) {
            const centersList = document.getElementById('centersList');
            const centerSelect = document.getElementById('employeeCenter');
            
            centersList.innerHTML = '';
            centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>';

            if (centers && centers.length > 0) {
                centers.forEach(center => {
                    // Display in list
                    const centerDiv = document.createElement('div');
                    centerDiv.className = 'item-card';
                    
                    let actionsHtml = '';
                    if (userPermissions.can_edit_centers) {
                        actionsHtml += `<button class="btn btn-success btn-small" onclick="editCenter(${center.id || center.center_id})">ØªØ¹Ø¯ÙŠÙ„</button>`;
                    }
                    if (userPermissions.can_delete_centers) {
                        actionsHtml += `<button class="btn btn-danger btn-small" onclick="deleteCenter(${center.id || center.center_id})">Ø­Ø°Ù</button>`;
                    }
                    
                    const centerName = center.name || center.center_name;
                    const centerLat = center.latitude;
                    const centerLng = center.longitude;
                    const centerRadius = center.radius;
                    const centerId = center.id || center.center_id;
                    
                    // Get stats for this center
                    const stats = centerStats[centerId] || { checkins: 0, checkouts: 0 };
                    
                    centerDiv.innerHTML = `
                        <div class="item-info">
                            <strong>${centerName}</strong><br>
                            <small>Ù†Ø·Ø§Ù‚: ${centerRadius} Ù…ØªØ± â€¢ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${centerLat.toFixed(4)}, ${centerLng.toFixed(4)}</small><br>
                            <small>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…: <span style="color: var(--checkin-color);">${stats.checkins}</span> â€¢ 
                            Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…: <span style="color: var(--checkout-color);">${stats.checkouts}</span></small>
                        </div>
                        <div class="item-actions">
                            ${actionsHtml}
                        </div>
                    `;
                    centersList.appendChild(centerDiv);

                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = center.id || center.center_id;
                    option.textContent = centerName;
                    centerSelect.appendChild(option);
                });
            } else {
                centersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙƒØ² Ù…ØªØ§Ø­Ø©</p>';
            }
        }

        function displayEmployees(employees) {
            const employeesList = document.getElementById('employeesList');
            const pagination = paginationState.employees;
            
            // Calculate pagination
            pagination.totalPages = Math.ceil(employees.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedEmployees = employees.slice(startIndex, endIndex);
            
            employeesList.innerHTML = '';

            if (paginatedEmployees && paginatedEmployees.length > 0) {
                paginatedEmployees.forEach(employee => {
                    const employeeDiv = document.createElement('div');
                    employeeDiv.className = `item-card employee-card ${employee.status}`;
                    
                    let actionsHtml = `
                        <span class="employee-status ${employee.status}">
                            ${employee.status === 'active' ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·'}
                        </span>
                    `;
                    
                    if (userPermissions.can_edit_employees) {
                        actionsHtml += `<button class="btn btn-success btn-small" onclick="editEmployee(${employee.id || employee.employee_id})">ØªØ¹Ø¯ÙŠÙ„</button>`;
                    }
                    if (userPermissions.can_delete_employees) {
                        actionsHtml += `<button class="btn btn-danger btn-small" onclick="deleteEmployee(${employee.id || employee.employee_id})">Ø­Ø°Ù</button>`;
                    }
                    
                    const empName = employee.name || employee.employee_name;
                    const empPhone = employee.phone;
                    const empPosition = employee.position || employee.job_position;
                    const empCenterName = employee.centers?.name || employee.center_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    
                    employeeDiv.innerHTML = `
                        <div class="item-info">
                            <strong>${empName}</strong><br>
                            <small>${empPosition || 'Ù…ÙˆØ¸Ù'} â€¢ ğŸ“± ${empPhone}</small><br>
                            <small>Ø§Ù„Ù…Ø±ÙƒØ²: ${empCenterName}</small>
                        </div>
                        <div class="item-actions">
                            ${actionsHtml}
                        </div>
                    `;
                    employeesList.appendChild(employeeDiv);
                });

                // Show pagination if needed
                const paginationDiv = document.getElementById('employeesPagination');
                if (pagination.totalPages > 1) {
                    paginationDiv.style.display = 'flex';
                    document.getElementById('employeesPageInfo').textContent = 
                        `ØµÙØ­Ø© ${pagination.currentPage} Ù…Ù† ${pagination.totalPages} (${employees.length} ÙØ±Ø¯)`;
                } else {
                    paginationDiv.style.display = 'none';
                }
            } else {
                employeesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ Ù…ØªØ§Ø­ÙŠÙ†</p>';
            }
        }

        // Enhanced Employee Locations with Search and Pagination
        async function refreshEmployeeLocations() {
            try {
                let employeeIds = [];
                
                if (currentUser.role === 'admin') {
                    const { data: allEmps } = await supabase.from('employees').select('id');
                    employeeIds = allEmps ? allEmps.map(emp => emp.id) : [];
                } else {
                    employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                }

                if (employeeIds.length === 0) {
                    document.getElementById('employeeLocations').innerHTML = 
                        '<p style="color: var(--text-secondary); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ù…ØªØ§Ø­Ø©</p>';
                    return;
                }

                const { data: latestLogs, error } = await supabase
                    .from('logs')
                    .select(`*, employees (id, name, status, phone), centers (name)`)
                    .in('employee_id', employeeIds)
                    .not('latitude', 'is', null)
                    .not('longitude', 'is', null)
                    .order('occurred_at', { ascending: false });

                if (error) throw error;

                // Group by employee and get latest location
                const employeeLocations = {};
                latestLogs.forEach(log => {
                    if (log.employees && !employeeLocations[log.employees.id]) {
                        employeeLocations[log.employees.id] = {
                            employee: log.employees,
                            center: log.centers,
                            location: {
                                latitude: log.latitude,
                                longitude: log.longitude,
                                action: log.action,
                                time: log.occurred_at || log.created_at
                            }
                        };
                    }
                });

                displayEmployeeLocations(employeeLocations);
                updateMapWithEmployees(employeeLocations);
            } catch (error) {
                console.error('Error loading employee locations:', error);
                document.getElementById('employeeLocations').innerHTML = 
                    '<p style="color: var(--text-secondary); text-align: center;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</p>';
            }
        }

        function displayEmployeeLocations(employeeLocations) {
            const container = document.getElementById('employeeLocations');
            const locations = Object.values(employeeLocations);
            
            // Apply search filter
            const searchTerm = document.getElementById('searchMovements')?.value.toLowerCase() || '';
            const filteredLocations = locations.filter(empData => 
                empData.employee.name.toLowerCase().includes(searchTerm)
            );
            
            // Pagination
            const pagination = paginationState.locations;
            pagination.totalPages = Math.ceil(filteredLocations.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedLocations = filteredLocations.slice(startIndex, endIndex);
            
            container.innerHTML = '';

            if (paginatedLocations.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø¯ÙŠØ«Ø©</p>';
                return;
            }

            paginatedLocations.forEach(empData => {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'location-card';
                
                const timeDiff = getTimeDifference(empData.location.time);
                const actionText = getActionText(empData.location.action);
                const statusText = empData.employee.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·';

                locationDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${empData.employee.name}
                                <span class="employee-status ${empData.employee.status}">
                                    ${empData.employee.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'} ${statusText}
                                </span>
                            </div>
                            <div style="font-size: 0.9em; margin-bottom: 3px;">
                                ğŸ“± ${empData.employee.phone} â€¢ ğŸ“ ${actionText}
                            </div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">
                                ğŸ“ ${empData.center?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} â€¢ ğŸ• <span class="time-ago" data-timestamp="${empData.location.time}">${timeDiff}</span>
                            </div>
                        </div>
                        <button class="btn btn-small" onclick="focusOnEmployee(${empData.location.latitude}, ${empData.location.longitude}, '${empData.employee.name}')">
                            ğŸ“ Ø¹Ø±Ø¶
                        </button>
                    </div>
                `;
                container.appendChild(locationDiv);
            });

            // Show pagination if needed
            const paginationDiv = document.getElementById('locationsPagination');
            if (pagination.totalPages > 1) {
                paginationDiv.style.display = 'flex';
                document.getElementById('locationsPageInfo').textContent = 
                    `ØµÙØ­Ø© ${pagination.currentPage} Ù…Ù† ${pagination.totalPages} (${filteredLocations.length} Ù…ÙˆÙ‚Ø¹)`;
            } else {
                paginationDiv.style.display = 'none';
            }
        }

        function focusOnEmployee(lat, lng, name) {
            if (!map) {
                showNotification('Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© Ø¨Ø¹Ø¯', 'warning');
                return;
            }

            map.flyTo({
                center: [lng, lat],
                zoom: 16,
                duration: 2000
            });
            
            showNotification(`ØªÙ… Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ ${name}`, 'info');
        }

        // Enhanced Logs Loading with Better Color Coding
        async function loadLogs() {
            try {
                let query = supabase
                    .from('logs')
                    .select(`*, employees (name, phone), centers (name)`)
                    .order('occurred_at', { ascending: false })
                    .limit(200);

                if (currentUser.role !== 'admin' && allowedEmployees.length > 0) {
                    const employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                    query = query.in('employee_id', employeeIds);
                }

                const { data: logs, error } = await query;
                if (error) throw error;

                allLogs = logs || [];
                displayLogs(allLogs);
                
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function displayLogs(logs) {
            const logsContainer = document.getElementById('activityLogs');
            
            // Pagination
            const pagination = paginationState.logs;
            pagination.totalPages = Math.ceil(logs.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedLogs = logs.slice(startIndex, endIndex);
            
            logsContainer.innerHTML = '';

            if (paginatedLogs && paginatedLogs.length > 0) {
                paginatedLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = `log-entry ${log.action}`;
                    
                    const logTime = log.occurred_at || log.created_at;
                    const timeAgo = getTimeDifference(logTime);
                    const fullTime = formatLocalDateTime(logTime);
                    
                    const actionText = getActionText(log.action);
                    const actionIcon = getActionIcon(log.action);
                    
                    // Enhanced display for checkin/checkout
                    let actionDisplay = actionText;
                    if (log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry') {
                        actionDisplay = `<span style="color: var(--checkin-color); font-weight: bold;">Ø¯Ø®Ù„ ${log.centers?.name ? 'Ø¥Ù„Ù‰ ' + log.centers.name : ''} Ø§Ù„Ø³Ø§Ø¹Ø© ${new Date(logTime).toLocaleTimeString('ar-IQ', {timeZone: 'Asia/Baghdad', hour12: true})}</span>`;
                    } else if (log.action.includes('checkout') || log.action === 'out') {
                        actionDisplay = `<span style="color: var(--checkout-color); font-weight: bold;">Ø®Ø±Ø¬ ${log.centers?.name ? 'Ù…Ù† ' + log.centers.name : ''} Ø§Ù„Ø³Ø§Ø¹Ø© ${new Date(logTime).toLocaleTimeString('ar-IQ', {timeZone: 'Asia/Baghdad', hour12: true})}</span>`;
                    }
                    
                    logDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${actionIcon} ${log.employees?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</strong>
                                <span style="margin: 0 10px;">â€¢</span>
                                <span>${actionDisplay}</span>
                            </div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">
                                <span class="time-ago" data-timestamp="${logTime}">${timeAgo}</span>
                            </div>
                        </div>
                        <div class="log-meta">
                            <span>ğŸ“… ${fullTime}</span>
                            ${log.notes ? `<span>ğŸ“ ${log.notes}</span>` : ''}
                        </div>
                    `;
                    logsContainer.appendChild(logDiv);
                });

                // Show pagination if needed
                const paginationDiv = document.getElementById('logsPagination');
                if (pagination.totalPages > 1) {
                    paginationDiv.style.display = 'flex';
                    document.getElementById('logsPageInfo').textContent = 
                        `ØµÙØ­Ø© ${pagination.currentPage} Ù…Ù† ${pagination.totalPages} (${logs.length} Ø³Ø¬Ù„)`;
                } else {
                    paginationDiv.style.display = 'none';
                }
            } else {
                logsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</p>';
            }
        }

        // Statistics Update - ENHANCED with Center Statistics
        async function updateStats() {
            try {
                let employeesCount, activeCount, centersCount, logsCount, checkedInCount, checkedOutCount;

                if (currentUser.role === 'admin') {
                    const [empRes, activeRes, centerRes, logsRes] = await Promise.all([
                        supabase.from('employees').select('*', { count: 'exact', head: true }),
                        supabase.from('employees').select('*', { count: 'exact', head: true }).eq('status', 'active'),
                        supabase.from('centers').select('*', { count: 'exact', head: true }),
                        supabase.from('logs').select('*', { count: 'exact', head: true }).gte('occurred_at', getTodayDateStart())
                    ]);
                    
                    employeesCount = empRes.count || 0;
                    activeCount = activeRes.count || 0;
                    centersCount = centerRes.count || 0;
                    logsCount = logsRes.count || 0;
                } else {
                    employeesCount = allowedEmployees.length;
                    activeCount = allowedEmployees.filter(emp => emp.status === 'active').length;
                    centersCount = allowedCenters.length;
                    
                    const employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                    if (employeeIds.length > 0) {
                        const { count } = await supabase
                            .from('logs')
                            .select('*', { count: 'exact', head: true })
                            .in('employee_id', employeeIds)
                            .gte('occurred_at', getTodayDateStart());
                        logsCount = count || 0;
                    } else {
                        logsCount = 0;
                    }
                }

                // Get checkin/checkout statistics for today
                let checkinQuery = supabase
                    .from('logs')
                    .select('employee_id', { count: 'exact', head: true })
                    .gte('occurred_at', getTodayDateStart())
                    .in('action', ['checkin', 'auto_checkin', 'in', 'center_entry']);

                let checkoutQuery = supabase
                    .from('logs')
                    .select('employee_id', { count: 'exact', head: true })
                    .gte('occurred_at', getTodayDateStart())
                    .in('action', ['checkout', 'auto_checkout', 'out']);

                if (currentUser.role !== 'admin' && allowedEmployees.length > 0) {
                    const employeeIds = allowedEmployees.map(emp => emp.employee_id || emp.id);
                    checkinQuery = checkinQuery.in('employee_id', employeeIds);
                    checkoutQuery = checkoutQuery.in('employee_id', employeeIds);
                }

                const [checkinRes, checkoutRes] = await Promise.all([checkinQuery, checkoutQuery]);
                checkedInCount = checkinRes.count || 0;
                checkedOutCount = checkoutRes.count || 0;

                document.getElementById('totalEmployees').textContent = employeesCount;
                document.getElementById('activeEmployees').textContent = activeCount;
                document.getElementById('checkedInEmployees').textContent = checkedInCount;
                document.getElementById('checkedOutEmployees').textContent = checkedOutCount;
                document.getElementById('totalCenters').textContent = centersCount;
                document.getElementById('todayLogs').textContent = logsCount;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Enhanced Map Functions with Center Statistics
        async function updateMapMarkers() {
            if (!map || !map.isStyleLoaded()) {
                console.log('Map not ready yet...');
                return;
            }

            try {
                // Clear existing layers
                ['centers-layer', 'center-labels'].forEach(layerId => {
                    if (map.getLayer(layerId)) map.removeLayer(layerId);
                });
                if (map.getSource('centers')) map.removeSource('centers');

                const centersToShow = currentUser.role === 'admin' ? allCenters : allowedCenters;

                if (centersToShow && centersToShow.length > 0) {
                    const geojsonData = {
                        type: 'FeatureCollection',
                        features: centersToShow.map(center => {
                            const centerId = center.id || center.center_id;
                            const stats = centerStats[centerId] || { checkins: 0, checkouts: 0 };
                            return {
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [center.longitude, center.latitude]
                                },
                                properties: {
                                    id: centerId,
                                    name: center.name || center.center_name,
                                    radius: center.radius,
                                    checkins: stats.checkins,
                                    checkouts: stats.checkouts
                                }
                            };
                        })
                    };

                    map.addSource('centers', {
                        type: 'geojson',
                        data: geojsonData
                    });

                    map.addLayer({
                        id: 'centers-layer',
                        type: 'circle',
                        source: 'centers',
                        paint: {
                            'circle-radius': 20,
                            'circle-color': currentUser.role === 'admin' ? '#667eea' : '#4facfe',
                            'circle-stroke-width': 4,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 0.8
                        }
                    });

                    map.addLayer({
                        id: 'center-labels',
                        type: 'symbol',
                        source: 'centers',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 3],
                            'text-anchor': 'top',
                            'text-size': 14,
                            'text-allow-overlap': true,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#2c3e50',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });

                    map.on('click', 'centers-layer', (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { name, radius, checkins, checkouts } = e.features[0].properties;

                        new mapboxgl.Popup({ 
                            closeOnClick: true,
                            className: 'arabic-popup'
                        })
                            .setLngLat(coordinates)
                            .setHTML(`
                                <div class="marker-popup">
                                    <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">ğŸ¢ ${name}</h3>
                                    <p style="margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px;"><strong>Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„:</strong> ${radius} Ù…ØªØ±</p>
                                    <div class="center-stats">
                                        <div class="stat-item checkin-stat">
                                            <div style="font-weight: bold; font-size: 18px;">${checkins}</div>
                                            <div style="font-size: 12px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
                                        </div>
                                        <div class="stat-item checkout-stat">
                                            <div style="font-weight: bold; font-size: 18px;">${checkouts}</div>
                                            <div style="font-size: 12px;">Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…</div>
                                        </div>
                                    </div>
                                </div>
                            `)
                            .addTo(map);
                    });

                    if (centersToShow.length > 1) {
                        const bounds = new mapboxgl.LngLatBounds();
                        centersToShow.forEach(center => {
                            bounds.extend([center.longitude, center.latitude]);
                        });
                        map.fitBounds(bounds, { padding: 50 });
                    }
                }
            } catch (error) {
                console.error('Error updating map markers:', error);
            }
        }

        function updateMapWithEmployees(employeeLocations) {
            if (!map || !map.isStyleLoaded()) return;

            // Clear existing employee layers
            ['employees-layer', 'employee-labels'].forEach(layerId => {
                if (map.getLayer(layerId)) map.removeLayer(layerId);
            });
            if (map.getSource('employees')) map.removeSource('employees');

            if (!employeeLocations || Object.keys(employeeLocations).length === 0) return;

            const employeesGeoJSON = {
                type: 'FeatureCollection',
                features: Object.values(employeeLocations).map(empData => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [empData.location.longitude, empData.location.latitude]
                    },
                    properties: {
                        name: empData.employee.name,
                        phone: empData.employee.phone,
                        status: empData.employee.status,
                        action: empData.location.action,
                        time: empData.location.time,
                        center: empData.center?.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                    }
                }))
            };

            map.addSource('employees', {
                type: 'geojson',
                data: employeesGeoJSON
            });

            map.addLayer({
                id: 'employees-layer',
                type: 'circle',
                source: 'employees',
                paint: {
                    'circle-radius': 12,
                    'circle-color': [
                        'case',
                        ['==', ['get', 'status'], 'active'],
                        '#28a745',
                        '#dc3545'
                    ],
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#ffffff'
                }
            });

            map.addLayer({
                id: 'employee-labels',
                type: 'symbol',
                source: 'employees',
                layout: {
                    'text-field': ['get', 'name'],
                    'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
                    'text-offset': [0, 2],
                    'text-anchor': 'top',
                    'text-size': 12,
                    'text-allow-overlap': true,
                    'text-ignore-placement': false
                },
                paint: {
                    'text-color': '#2c3e50',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 1
                }
            });

            map.on('click', 'employees-layer', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const properties = e.features[0].properties;
                const timeDiff = getTimeDifference(properties.time);

                new mapboxgl.Popup({ 
                    closeOnClick: true,
                    className: 'arabic-popup'
                })
                    .setLngLat(coordinates)
                    .setHTML(`
                        <div class="marker-popup">
                            <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">${properties.name}</h3>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${properties.phone}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${properties.status === 'active' ? 'ğŸŸ¢ Ù†Ø´Ø·' : 'ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·'}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·:</strong> ${getActionText(properties.action)}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØª:</strong> ${timeDiff}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>Ø§Ù„Ù…Ø±ÙƒØ²:</strong> ${properties.center}</p>
                        </div>
                    `)
                    .addTo(map);
            });

            map.on('mouseenter', 'employees-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'employees-layer', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        // Pagination Functions
        function nextPage(type) {
            const pagination = paginationState[type];
            if (pagination.currentPage < pagination.totalPages) {
                pagination.currentPage++;
                
                switch(type) {
                    case 'employees':
                        displayEmployees(currentUser.role === 'admin' ? allEmployees : allowedEmployees);
                        break;
                    case 'locations':
                        refreshEmployeeLocations();
                        break;
                    case 'logs':
                        displayLogs(allLogs);
                        break;
                }
            }
        }

        function previousPage(type) {
            const pagination = paginationState[type];
            if (pagination.currentPage > 1) {
                pagination.currentPage--;
                
                switch(type) {
                    case 'employees':
                        displayEmployees(currentUser.role === 'admin' ? allEmployees : allowedEmployees);
                        break;
                    case 'locations':
                        refreshEmployeeLocations();
                        break;
                    case 'logs':
                        displayLogs(allLogs);
                        break;
                }
            }
        }

        // Search and Filter Functions
        function filterEmployees() {
            const searchTerm = document.getElementById('searchEmployees').value.toLowerCase();
            const employees = currentUser.role === 'admin' ? allEmployees : allowedEmployees;
            const filteredEmployees = employees.filter(emp => 
                (emp.name || emp.employee_name).toLowerCase().includes(searchTerm) ||
                emp.phone.includes(searchTerm) ||
                (emp.position || emp.job_position || '').toLowerCase().includes(searchTerm)
            );
            
            // Reset pagination
            paginationState.employees.currentPage = 1;
            displayEmployees(filteredEmployees);
        }

        function filterCenters() {
            const searchTerm = document.getElementById('searchCenters').value.toLowerCase();
            const centerCards = document.querySelectorAll('#centersList .item-card');
            
            centerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterMovements() {
            // This will trigger refreshEmployeeLocations which handles the search
            refreshEmployeeLocations();
        }

        function clearMovementSearch() {
            document.getElementById('searchMovements').value = '';
            refreshEmployeeLocations();
        }

        function filterLogs(type = 'all') {
            let filteredLogs = allLogs;
            
            if (type !== 'all') {
                if (type === 'checkin') {
                    filteredLogs = allLogs.filter(log => 
                        log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry'
                    );
                } else if (type === 'checkout') {
                    filteredLogs = allLogs.filter(log => 
                        log.action.includes('checkout') || log.action === 'out'
                    );
                } else if (type === 'movement') {
                    filteredLogs = allLogs.filter(log => 
                        log.action.includes('movement') || log.action.includes('nearby')
                    );
                } else if (type === 'center_entry') {
                    filteredLogs = allLogs.filter(log => log.action === 'center_entry');
                } else {
                    filteredLogs = allLogs.filter(log => log.action === type);
                }
            }
            
            // Reset pagination
            paginationState.logs.currentPage = 1;
            displayLogs(filteredLogs);
            showNotification(`ØªÙ… ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${filteredLogs.length} Ø³Ø¬Ù„`, 'info', 2000);
        }

        // Focus Functions for Stats
        function focusOnEmployees() {
            document.querySelector('#employeesList')?.scrollIntoView({ behavior: 'smooth' });
            showNotification('Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙØ±Ø§Ø¯', 'info', 2000);
        }

        function focusOnActiveEmployees() {
            document.querySelector('#employeeLocations')?.scrollIntoView({ behavior: 'smooth' });
            showNotification('Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†', 'info', 2000);
        }

        function focusOnCheckedIn() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('logFilter').value = 'checkin';
            filterLogs('checkin');
            showNotification('Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„', 'success', 2000);
        }

        function focusOnCheckedOut() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('logFilter').value = 'checkout';
            filterLogs('checkout');
            showNotification('Ø¹Ø±Ø¶ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬', 'error', 2000);
        }

        function focusOnCenters() {
            document.querySelector('#centersList')?.scrollIntoView({ behavior: 'smooth' });
            showNotification('Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø§ÙƒØ²', 'info', 2000);
        }

        function focusOnLogs() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            showNotification('Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©', 'info', 2000);
        }

        // CRUD Functions - Same as before but enhanced
        async function addCenter() {
            if (!userPermissions.can_add_centers) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø§ÙƒØ²', 'warning');
                return;
            }

            const name = document.getElementById('centerName').value.trim();
            const lng = parseFloat(document.getElementById('centerLng').value);
            const lat = parseFloat(document.getElementById('centerLat').value);
            const radius = parseInt(document.getElementById('centerRadius').value);

            if (!name || !lng || !lat || !radius) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©', 'warning');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('centers')
                    .insert([{ name, longitude: lng, latitude: lat, radius }])
                    .select();

                if (error) throw error;

                // Add permission for this user to access the new center if regular user
                if (currentUser.role !== 'admin' && data[0]) {
                    await supabase
                        .from('user_center_permissions')
                        .insert([{
                            user_id: currentUser.id,
                            center_id: data[0].id,
                            can_view: true,
                            can_manage: true
                        }]);
                }

                // Clear form
                document.getElementById('centerName').value = '';
                document.getElementById('centerLng').value = '';
                document.getElementById('centerLat').value = '';
                document.getElementById('centerRadius').value = '100';

                await loadAllData();
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                console.error('Error adding center:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙƒØ²', 'error');
            }
        }

        async function addEmployee() {
            if (!userPermissions.can_add_employees) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙØ±Ø§Ø¯', 'warning');
                return;
            }

            const name = document.getElementById('employeeName').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const password = document.getElementById('employeePassword').value.trim();
            const position = document.getElementById('employeePosition').value.trim();
            const centerId = document.getElementById('employeeCenter').value;

            if (!name || !phone || !password || !centerId) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            if (password.length < 6) {
                showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                return;
            }

            // Check if user has permission for this center
            if (currentUser.role !== 'admin') {
                const hasPermission = allowedCenters.some(center => 
                    (center.center_id || center.id) == centerId && center.can_manage !== false
                );

                if (!hasPermission) {
                    showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙØ±Ø§Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙƒØ²', 'warning');
                    return;
                }
            }

            try {
                const { data, error } = await supabase.rpc('add_employee', {
                    employee_name: name,
                    employee_phone: phone,
                    employee_password: password,
                    employee_position: position || 'ÙØ±Ø¯',
                    employee_center_id: parseInt(centerId)
                });

                if (error) throw error;

                const result = data;
                if (result.success) {
                    // Clear form
                    document.getElementById('employeeName').value = '';
                    document.getElementById('employeePhone').value = '';
                    document.getElementById('employeePassword').value = '';
                    document.getElementById('employeePosition').value = '';
                    document.getElementById('employeeCenter').value = '';

                    await loadAllData();
                    showNotification(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                } else {
                    showNotification('âŒ ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding employee:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ø¯: ' + error.message, 'error');
            }
        }

        async function addUser() {
            if (currentUser.role !== 'admin') {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'warning');
                return;
            }

            const username = document.getElementById('newUsername').value.trim();
            const fullName = document.getElementById('newUserFullName').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const role = document.getElementById('newUserRole').value;

            if (!username || !fullName || !password) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ØŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)', 'warning');
                return;
            }

            if (password.length < 6) {
                showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
                return;
            }

            try {
                const { data, error } = await supabase.rpc('add_user', {
                    user_username: username,
                    user_password: password,
                    user_full_name: fullName,
                    user_email: email || null,
                    user_phone: phone || null,
                    user_role: role,
                    center_ids: null
                });

                if (error) throw error;

                const result = data;
                if (result.success) {
                    // Clear form
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPhone').value = '';
                    document.getElementById('newUserRole').value = 'user';

                    showNotification(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${fullName}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                } else {
                    showNotification('âŒ ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message, 'error');
            }
        }

        // Edit Functions - Same as before
        function editEmployee(employeeId) {
            if (!userPermissions.can_edit_employees) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙØ±Ø§Ø¯', 'warning');
                return;
            }

            const employee = (currentUser.role === 'admin' ? allEmployees : allowedEmployees)
                .find(emp => (emp.id || emp.employee_id) === employeeId);
            
            if (!employee) return;

            currentEditingEmployee = employee;

            document.getElementById('editEmployeeName').value = employee.name || employee.employee_name;
            document.getElementById('editEmployeePhone').value = employee.phone;
            document.getElementById('editEmployeePosition').value = employee.position || '';
            document.getElementById('editEmployeeStatus').value = employee.status;
            
            // Populate center dropdown
            const centerSelect = document.getElementById('editEmployeeCenter');
            centerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙƒØ²</option>';
            
            const centersToShow = currentUser.role === 'admin' ? allCenters : allowedCenters;
            centersToShow.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id || center.center_id;
                option.textContent = center.name || center.center_name;
                if ((center.id || center.center_id) === employee.center_id) {
                    option.selected = true;
                }
                centerSelect.appendChild(option);
            });

            showModal('editEmployeeModal');
        }

        function editCenter(centerId) {
            if (!userPermissions.can_edit_centers) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ²', 'warning');
                return;
            }

            const center = (currentUser.role === 'admin' ? allCenters : allowedCenters)
                .find(c => (c.id || c.center_id) === centerId);
            
            if (!center) return;

            currentEditingCenter = center;

            document.getElementById('editCenterName').value = center.name || center.center_name;
            document.getElementById('editCenterLng').value = center.longitude;
            document.getElementById('editCenterLat').value = center.latitude;
            document.getElementById('editCenterRadius').value = center.radius;

            showModal('editCenterModal');
        }

        async function updateEmployee() {
            if (!currentEditingEmployee || !userPermissions.can_edit_employees) return;

            const name = document.getElementById('editEmployeeName').value.trim();
            const phone = document.getElementById('editEmployeePhone').value.trim();
            const position = document.getElementById('editEmployeePosition').value.trim();
            const status = document.getElementById('editEmployeeStatus').value;
            const centerId = document.getElementById('editEmployeeCenter').value;

            if (!name || !phone) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'warning');
                return;
            }

            try {
                const { error } = await supabase
                    .from('employees')
                    .update({
                        name: name,
                        phone: phone,
                        position: position,
                        status: status,
                        center_id: centerId || null
                    })
                    .eq('id', currentEditingEmployee.id || currentEditingEmployee.employee_id);

                if (error) throw error;

                closeModal('editEmployeeModal');
                await loadAllData();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                console.error('Error updating employee:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        async function updateCenter() {
            if (!currentEditingCenter || !userPermissions.can_edit_centers) return;

            const name = document.getElementById('editCenterName').value.trim();
            const lng = parseFloat(document.getElementById('editCenterLng').value);
            const lat = parseFloat(document.getElementById('editCenterLat').value);
            const radius = parseInt(document.getElementById('editCenterRadius').value);

            if (!name || !lng || !lat || !radius) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'warning');
                return;
            }

            try {
                const { error } = await supabase
                    .from('centers')
                    .update({
                        name: name,
                        longitude: lng,
                        latitude: lat,
                        radius: radius
                    })
                    .eq('id', currentEditingCenter.id || currentEditingCenter.center_id);

                if (error) throw error;

                closeModal('editCenterModal');
                await loadAllData();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
            } catch (error) {
                console.error('Error updating center:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // Delete Functions - Same as before
        async function deleteCenter(centerId) {
            if (!userPermissions.can_delete_centers) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø§ÙƒØ²', 'warning');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙƒØ²ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ù‡.')) {
                try {
                    const { error } = await supabase
                        .from('centers')
                        .delete()
                        .eq('id', centerId);

                    if (error) throw error;
                    await loadAllData();
                    showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙƒØ² Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                } catch (error) {
                    console.error('Error deleting center:', error);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙƒØ²', 'error');
                }
            }
        }

        async function deleteEmployee(employeeId) {
            if (!userPermissions.can_delete_employees) {
                showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ø§Ù„Ø£ÙØ±Ø§Ø¯', 'warning');
                return;
            }

            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                try {
                    const { error } = await supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);

                    if (error) throw error;
                    await loadAllData();
                    showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }
        }

        // Refresh Functions
        async function refreshAll() {
            try {
                updateConnectionStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...', 'syncing');
                showRefreshIndicator();
                await loadAllData();
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ğŸ”„', 'success');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        function refreshLogs() {
            loadLogs();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª', 'info', 2000);
        }

        // Helper Functions
        function getActionText(action) {
            const actions = {
                'auto_checkin': 'Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                'auto_checkout': 'Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
                'center_entry': 'Ø¯Ø®Ù„ Ù…Ø±ÙƒØ²',
                'center_nearby': 'Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ù…Ø±ÙƒØ²',
                'movement': 'Ø­Ø±ÙƒØ©',
                'location_update': 'ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹',
                'checkin': 'Ø¯Ø®ÙˆÙ„',
                'checkout': 'Ø®Ø±ÙˆØ¬',
                'in': 'Ø¯Ø®ÙˆÙ„',
                'out': 'Ø®Ø±ÙˆØ¬'
            };
            return actions[action] || action;
        }

        function getActionIcon(action) {
            const icons = {
                'auto_checkin': 'ğŸŸ¢',
                'auto_checkout': 'ğŸ”´',
                'center_entry': 'ğŸ¢',
                'center_nearby': 'ğŸ“',
                'movement': 'ğŸš¶',
                'location_update': 'ğŸ“',
                'checkin': 'âœ…',
                'checkout': 'âŒ',
                'in': 'âœ…',
                'out': 'âŒ'
            };
            return icons[action] || 'ğŸ“‹';
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Theme toggle function
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            }
        }

        // Real-time Updates Setup
        function setupRealTimeUpdates() {
            // Subscribe to logs changes
            supabase
                .channel('enhanced_logs_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'logs' }, (payload) => {
                    console.log('New log activity detected:', payload);
                    loadLogs();
                    updateStats();
                    loadCenterStats();
                    refreshEmployeeLocations();
                    
                    // Show notification for new activities
                    if (payload.eventType === 'INSERT' && payload.new) {
                        const actionText = getActionText(payload.new.action);
                        showNotification(`Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯: ${actionText}`, 'info', 5000);
                    }
                })
                .subscribe();

            // Subscribe to employee changes
            supabase
                .channel('enhanced_employees_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'employees' }, () => {
                    loadAllData();
                })
                .subscribe();

            // Subscribe to centers changes
            supabase
                .channel('enhanced_centers_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'centers' }, () => {
                    loadAllData();
                })
                .subscribe();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshAll();
                        break;
                }
            }
        });

        // Add Enter key support for login
        document.addEventListener('DOMContentLoaded', function() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            
            usernameInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') passwordInput?.focus();
            });
            
            passwordInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Make functions globally available
        window.login = login;
        window.logout = logout;
        window.toggleTheme = toggleTheme;
        window.filterLogs = filterLogs;
        window.focusOnEmployees = focusOnEmployees;
        window.focusOnActiveEmployees = focusOnActiveEmployees;
        window.focusOnCheckedIn = focusOnCheckedIn;
        window.focusOnCheckedOut = focusOnCheckedOut;
        window.focusOnCenters = focusOnCenters;
        window.focusOnLogs = focusOnLogs;
        window.refreshMap = refreshMap;
        window.fitAllMarkers = fitAllMarkers;
        window.showAllEmployeesOnMap = showAllEmployeesOnMap;
        window.toggleMapStyle = toggleMapStyle;
        window.toggleSection = toggleSection;
        window.addCenter = addCenter;
        window.addEmployee = addEmployee;
        window.addUser = addUser;
        window.refreshLogs = refreshLogs;
        window.refreshAll = refreshAll;
        window.locateMe = locateMe;
        window.filterEmployees = filterEmployees;
        window.filterCenters = filterCenters;
        window.filterMovements = filterMovements;
        window.clearMovementSearch = clearMovementSearch;
        window.refreshEmployeeLocations = refreshEmployeeLocations;
        window.editEmployee = editEmployee;
        window.editCenter = editCenter;
        window.updateEmployee = updateEmployee;
        window.updateCenter = updateCenter;
        window.deleteEmployee = deleteEmployee;
        window.deleteCenter = deleteCenter;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.focusOnEmployee = focusOnEmployee;
        window.nextPage = nextPage;
        window.previousPage = previousPage;
    </script>
</body>
</html>
