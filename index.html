<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم المتقدمة</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-color: #f8f9fa;
            --card-bg: white;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e0e0e0;
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --hover-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 5px 15px rgba(0,0,0,0.3);
            --hover-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Login Screen Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--primary-gradient);
            padding: 20px;
        }

        .login-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            width: auto;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        /* Main Dashboard Styles */
        .dashboard-container {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-container.active {
            display: block;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .logo-section h1 {
            color: var(--text-color);
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Layout Structure */
        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Stats Cards - Clickable */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        /* Search Section */
        .search-section {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        .locate-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Map Section */
        .map-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        #map {
            height: 500px;
            border-radius: 10px;
        }

        /* Collapsible Sections */
        .sidebar-section {
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .section-header:hover {
            background: linear-gradient(135deg, #7c8ef0 0%, #8a5cb8 100%);
        }

        .section-header .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .section-header.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 20px;
            background: var(--card-bg);
            max-height: 1000px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .section-tip {
            background: #e3f2fd;
            color: #1565c0;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        /* Data Display */
        .data-section {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .item-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            transition: all 0.3s;
        }

        .item-card:hover {
            transform: translateX(-5px);
            box-shadow: var(--shadow);
        }

        .item-info {
            flex: 1;
        }

        .item-info strong {
            display: block;
            font-size: 1.1em;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .item-info small {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        /* Status indicators */
        .employee-card.active {
            border-right-color: #27ae60;
        }

        .employee-card.inactive {
            border-right-color: #e74c3c;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-active {
            background: #d5f4e6;
            color: #27ae60;
        }

        .status-inactive {
            background: #fdeaea;
            color: #e74c3c;
        }

        /* Logs */
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background: var(--bg-color);
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            border-right: 4px solid;
        }

        .log-entry.in {
            background: #d5f4e6;
            color: #155724;
            border-right-color: #27ae60;
        }

        .log-entry.out {
            background: #fdeaea;
            color: #721c24;
            border-right-color: #e74c3c;
        }

        .log-entry.move {
            background: #fff3cd;
            color: #856404;
            border-right-color: #ffc107;
        }

        .log-entry.out_of_range {
            background: #f8d7da;
            color: #721c24;
            border-right-color: #dc3545;
        }

        /* Notifications */
        .notifications {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            max-width: 400px;
        }

        .notification {
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
        }

        .notification.success { background: #27ae60; }
        .notification.warning { background: #f39c12; }
        .notification.info { background: #17a2b8; }
        .notification.error { background: #dc3545; }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-color);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .content-area {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .search-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Dark theme map styles */
        [data-theme="dark"] .mapboxgl-popup-content {
            background: #2d2d2d;
            color: white;
        }

        /* Arabic text support for map */
        .mapboxgl-canvas {
            font-feature-settings: "liga" off;
        }
        
        .mapboxgl-popup-content,
        .arabic-popup .mapboxgl-popup-content {
            direction: rtl !important;
            text-align: right !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            unicode-bidi: bidi-override !important;
        }
        
        .mapboxgl-ctrl-group button {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Ensure proper Arabic text rendering in popups */
        .arabic-popup h3,
        .arabic-popup p {
            unicode-bidi: embed !important;
            direction: rtl !important;
        }

        /* Additional animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #27ae60;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="notifications" id="notifications"></div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <h1>🔐 تسجيل الدخول</h1>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">لوحة التحكم الإدارية</p>
            
            <div class="form-group">
                <label>اسم المستخدم</label>
                <input type="text" id="loginUsername" placeholder="أدخل اسم المستخدم">
            </div>
            
            <div class="form-group">
                <label>كلمة المرور</label>
                <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور">
            </div>
            
            <button class="btn" onclick="login()">دخول</button>
            
            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 0.9em;">
                <strong>معلومات تجريبية:</strong><br>
                المستخدم: admin<br>
                كلمة المرور: admin123
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container" id="dashboard">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo-section">
                <h1>🎛️ لوحة التحكم المتقدمة</h1>
                <p style="color: var(--text-secondary);">إدارة شاملة للمراكز والأفراد <span class="real-time-indicator"></span></p>
            </div>
            
            <div class="user-section">
                <span id="welcomeMessage">مرحباً، admin</span>
                <button class="theme-toggle" onclick="toggleTheme()" title="تغيير السمة">🌙</button>
                <button class="btn btn-danger btn-small" onclick="logout()">خروج</button>
            </div>
        </div>

        <!-- Statistics Dashboard - Clickable -->
        <div class="stats-grid">
            <div class="stat-card" onclick="showEmployeesModal()" title="انقر لعرض التفاصيل">
                <span class="stat-number" id="totalEmployees">0</span>
                <div class="stat-label">إجمالي الأفراد</div>
            </div>
            <div class="stat-card" onclick="showActiveEmployeesModal()" title="انقر لعرض النشطين">
                <span class="stat-number" id="activeEmployees">0</span>
                <div class="stat-label">الأفراد النشطين</div>
            </div>
            <div class="stat-card" onclick="showCentersModal()" title="انقر لعرض المراكز">
                <span class="stat-number" id="totalCenters">0</span>
                <div class="stat-label">إجمالي المراكز</div>
            </div>
            <div class="stat-card" onclick="showTodayLogsModal()" title="انقر لعرض سجلات اليوم">
                <span class="stat-number" id="todayLogs">0</span>
                <div class="stat-label">سجلات اليوم</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <input type="text" class="search-input" id="searchEmployees" placeholder="🔍 البحث عن فرد..." oninput="filterEmployees()">
            <input type="text" class="search-input" id="searchCenters" placeholder="🔍 البحث عن مركز..." oninput="filterCenters()">
            <button class="locate-btn" onclick="locateMe()" title="تحديد موقعي">📍 موقعي</button>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar with Collapsible Sections -->
            <div class="sidebar">
                <!-- Add Center Section -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('centerSection')">
                        <span>🏢 إضافة مركز جديد</span>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="section-content" id="centerSection">
                        <div class="section-tip">
                            💡 انقر على الخريطة لتحديد الموقع
                        </div>
                        
                        <div class="form-group">
                            <label>اسم المركز</label>
                            <input type="text" id="centerName" placeholder="أدخل اسم المركز">
                        </div>
                        <div class="form-group">
                            <label>خط الطول</label>
                            <input type="number" id="centerLng" step="any" placeholder="سيتم ملؤه تلقائياً">
                        </div>
                        <div class="form-group">
                            <label>خط العرض</label>
                            <input type="number" id="centerLat" step="any" placeholder="سيتم ملؤه تلقائياً">
                        </div>
                        <div class="form-group">
                            <label>نطاق المركز (متر)</label>
                            <input type="number" id="centerRadius" value="100" placeholder="100">
                        </div>
                        <button class="btn" onclick="addCenter()">إضافة المركز</button>
                    </div>
                </div>

                <!-- Add Employee Section -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('employeeSection')">
                        <span>👤 إضافة فرد جديد</span>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="section-content" id="employeeSection">
                        <div class="form-group">
                            <label>اسم الفرد</label>
                            <input type="text" id="employeeName" placeholder="أدخل اسم الفرد">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="text" id="employeePhone" placeholder="رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="employeePassword" placeholder="كلمة مرور قوية">
                        </div>
                        <div class="form-group">
                            <label>المنصب</label>
                            <input type="text" id="employeePosition" placeholder="المنصب/الوظيفة">
                        </div>
                        <div class="form-group">
                            <label>المركز المخصص</label>
                            <select id="employeeCenter">
                                <option value="">اختر المركز</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addEmployee()">إضافة فرد</button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Map Section -->
                <div class="map-container">
                    <h2 style="color: var(--text-color); margin-bottom: 15px;">🗺️ الخريطة التفاعلية</h2>
                    <div id="map"></div>
                </div>

                <!-- Employee Locations -->
                <div class="data-section">
                    <div class="section-title">
                        <span>📍 المواقع المباشرة</span>
                        <button class="btn btn-small" onclick="refreshEmployeeLocations()">🔄 تحديث</button>
                    </div>
                    <div id="employeeLocations"></div>
                </div>

                <!-- Data Display -->
                <div class="data-section">
                    <h2 class="section-title">📊 إدارة البيانات</h2>
                    <div class="data-grid">
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">المراكز المضافة</h3>
                            <div id="centersList"></div>
                        </div>
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">قائمة الأفراد</h3>
                            <div id="employeesList"></div>
                        </div>
                    </div>
                </div>

                <!-- Activity Logs -->
                <div class="data-section">
                    <h2 class="section-title">📋 سجل الأنشطة المباشر</h2>
                    <div class="logs-container" id="activityLogs"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Edit Employee Modal -->
    <div id="editEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">تعديل بيانات الفرد</h2>
                <span class="close" onclick="closeModal('editEmployeeModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>اسم الفرد</label>
                <input type="text" id="editEmployeeName">
            </div>
            <div class="form-group">
                <label>رقم الهاتف</label>
                <input type="text" id="editEmployeePhone">
            </div>
            <div class="form-group">
                <label>المنصب</label>
                <input type="text" id="editEmployeePosition">
            </div>
            <div class="form-group">
                <label>المركز</label>
                <select id="editEmployeeCenter"></select>
            </div>
            <div class="form-group">
                <label>الحالة</label>
                <select id="editEmployeeStatus">
                    <option value="active">نشط</option>
                    <option value="inactive">غير نشط</option>
                </select>
            </div>
            <button class="btn" onclick="updateEmployee()">حفظ التغييرات</button>
        </div>
    </div>

    <!-- Edit Center Modal -->
    <div id="editCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">تعديل بيانات المركز</h2>
                <span class="close" onclick="closeModal('editCenterModal')">&times;</span>
            </div>
            <div class="form-group">
                <label>اسم المركز</label>
                <input type="text" id="editCenterName">
            </div>
            <div class="form-group">
                <label>خط الطول</label>
                <input type="number" id="editCenterLng" step="any">
            </div>
            <div class="form-group">
                <label>خط العرض</label>
                <input type="number" id="editCenterLat" step="any">
            </div>
            <div class="form-group">
                <label>نطاق المركز (متر)</label>
                <input type="number" id="editCenterRadius">
            </div>
            <button class="btn" onclick="updateCenter()">حفظ التغييرات</button>
        </div>
    </div>

    <script>
        // Global Variables
        let supabase;
        let map;
        let currentUser = null;
        let allEmployees = [];
        let allCenters = [];
        let currentEditingEmployee = null;
        let currentEditingCenter = null;

        // Session Management (in-memory storage)
        const SESSION_KEY = 'dashboard_session';
        let sessionData = {
            isLoggedIn: false,
            username: null,
            loginTime: null
        };

        // Supabase Configuration
        const supabaseUrl = 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';

        // Mapbox Configuration
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW1lZXI3ZWx3YXMiLCJhIjoiY21iODAxaTFyMGFsajJqc2J2dGtvY2pmdSJ9.MNY-7y2onlfAnM0PUhNt8g';

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Application starting...');
            
            // Initialize section states
            initializeSections();
            
            // Check if user is already logged in
            if (sessionData.isLoggedIn) {
                showDashboard();
            }

            try {
                await initializeSupabase();
                console.log('تم تحميل النظام بنجاح');
            } catch (error) {
                console.error('خطأ في تحميل النظام:', error);
                showNotification('خطأ في تحميل النظام: ' + error.message, 'error');
            }
        });

        // Initialize Section States
        function initializeSections() {
            // Set initial states for collapsible sections
            document.getElementById('centerSection').classList.add('collapsed');
            document.getElementById('employeeSection').classList.add('collapsed');
            document.querySelector('#centerSection').parentElement.querySelector('.section-header').classList.add('collapsed');
            document.querySelector('#employeeSection').parentElement.querySelector('.section-header').classList.add('collapsed');
        }

        // Toggle Section Visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.parentElement.querySelector('.section-header');
            
            section.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        // Initialize Supabase
        function initializeSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function checkSupabase() {
                    attempts++;
                    if (window.supabase) {
                        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase initialized successfully');
                        resolve(supabase);
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkSupabase, 200);
                    } else {
                        reject(new Error('فشل في تحميل قاعدة البيانات'));
                    }
                }
                checkSupabase();
            });
        }

        // Authentication Functions
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showNotification('يرجى إدخال اسم المستخدم وكلمة المرور', 'warning');
                return;
            }

            // Simple demo authentication
            if (username === 'admin' && password === 'admin123') {
                sessionData = {
                    isLoggedIn: true,
                    username: username,
                    loginTime: new Date().toISOString()
                };
                
                showNotification('تم تسجيل الدخول بنجاح! 🎉', 'success');
                setTimeout(() => {
                    showDashboard();
                }, 1000);
            } else {
                showNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            }
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                sessionData = {
                    isLoggedIn: false,
                    username: null,
                    loginTime: null
                };
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboard').classList.remove('active');
                
                // Clear form
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                showNotification('تم تسجيل الخروج بنجاح', 'info');
            }
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            document.getElementById('welcomeMessage').textContent = `مرحباً، ${sessionData.username}`;
            
            // Initialize dashboard with delay to ensure proper loading
            setTimeout(() => {
                initializeMap();
                setTimeout(() => {
                    loadData();
                    setupRealTimeUpdates();
                }, 1000);
            }, 500);
        }

        // Theme Management
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeToggle.textContent = '🌙';
                themeToggle.title = 'الوضع المظلم';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '☀️';
                themeToggle.title = 'الوضع المضيء';
            }
        }

        // Map Functions
        function initializeMap() {
        // تفعيل دعم النصوص العربية RTL
        mapboxgl.setRTLTextPlugin(
            'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js',
            null,
            true
        );

            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [44.3661, 32.6155], // Karbala coordinates
                    zoom: 12,
                    locale: 'ar'
                });

                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl(), 'top-left');

                // Add click event for center selection
                map.on('click', function(e) {
                    const coordinates = e.lngLat;
                    document.getElementById('centerLng').value = coordinates.lng.toFixed(6);
                    document.getElementById('centerLat').value = coordinates.lat.toFixed(6);
                    
                    showNotification(`تم تحديد الموقع: ${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}`, 'success');
                });

                map.on('load', function() {
                    console.log('Map loaded successfully');
                    updateMapMarkers();
                });

                map.on('error', function(e) {
                    console.error('Map error:', e);
                });

            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('خطأ في تحميل الخريطة', 'error');
            }
        }

        // Locate user position
        function locateMe() {
            if (!map) {
                showNotification('الخريطة غير محملة بعد. يرجى الانتظار قليلاً...', 'warning');
                return;
            }

            if (navigator.geolocation) {
                showNotification('جاري تحديد موقعك...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const { latitude, longitude } = position.coords;
                        
                        map.flyTo({
                            center: [longitude, latitude],
                            zoom: 16,
                            duration: 2000
                        });

                        // Add marker for user location with proper Arabic text
                        new mapboxgl.Marker({ color: '#ff6b6b' })
                            .setLngLat([longitude, latitude])
                            .setPopup(new mapboxgl.Popup({ className: 'arabic-popup' }).setHTML('<div style="direction: rtl; text-align: center; font-family: \'Segoe UI\', Arial, sans-serif;"><strong>📍 موقعك الحالي</strong></div>'))
                            .addTo(map);

                        showNotification('تم تحديد موقعك بنجاح! 📍', 'success');
                    },
                    function(error) {
                        showNotification('تعذر تحديد الموقع. يرجى التأكد من تفعيل خدمات الموقع.', 'error');
                    }
                );
            } else {
                showNotification('خدمات الموقع غير مدعومة في هذا المتصفح', 'error');
            }
        }

        // Search and Filter Functions
        function filterEmployees() {
            const searchTerm = document.getElementById('searchEmployees').value.toLowerCase();
            const employeeCards = document.querySelectorAll('#employeesList .item-card');
            
            employeeCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterCenters() {
            const searchTerm = document.getElementById('searchCenters').value.toLowerCase();
            const centerCards = document.querySelectorAll('#centersList .item-card');
            
            centerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Clickable Stats Functions
        function showEmployeesModal() {
            showNotification('عرض جميع الأفراد...', 'info');
            document.getElementById('searchEmployees').focus();
        }

        function showActiveEmployeesModal() {
            showNotification('تصفية الأفراد النشطين...', 'info');
            filterActiveEmployees();
        }

        function showCentersModal() {
            showNotification('عرض جميع المراكز...', 'info');
            document.getElementById('searchCenters').focus();
        }

        function showTodayLogsModal() {
            showNotification('عرض سجلات اليوم...', 'info');
            scrollToLogs();
        }

        function filterActiveEmployees() {
            const employeeCards = document.querySelectorAll('#employeesList .item-card');
            employeeCards.forEach(card => {
                if (card.classList.contains('active')) {
                    card.style.display = 'flex';
                    card.style.background = 'rgba(39, 174, 96, 0.1)';
                } else {
                    card.style.display = 'none';
                }
            });
            
            setTimeout(() => {
                employeeCards.forEach(card => {
                    card.style.display = 'flex';
                    card.style.background = '';
                });
            }, 3000);
        }

        function scrollToLogs() {
            document.getElementById('activityLogs').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Edit Functions
        function editEmployee(employeeId) {
            currentEditingEmployee = allEmployees.find(emp => emp.id === employeeId);
            if (!currentEditingEmployee) return;

            document.getElementById('editEmployeeName').value = currentEditingEmployee.name;
            document.getElementById('editEmployeePhone').value = currentEditingEmployee.phone;
            document.getElementById('editEmployeePosition').value = currentEditingEmployee.position || '';
            document.getElementById('editEmployeeStatus').value = currentEditingEmployee.status;
            
            // Populate center dropdown
            const centerSelect = document.getElementById('editEmployeeCenter');
            centerSelect.innerHTML = '<option value="">اختر المركز</option>';
            allCenters.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id;
                option.textContent = center.name;
                if (center.id === currentEditingEmployee.center_id) {
                    option.selected = true;
                }
                centerSelect.appendChild(option);
            });

            showModal('editEmployeeModal');
        }

        function editCenter(centerId) {
            currentEditingCenter = allCenters.find(center => center.id === centerId);
            if (!currentEditingCenter) return;

            document.getElementById('editCenterName').value = currentEditingCenter.name;
            document.getElementById('editCenterLng').value = currentEditingCenter.longitude;
            document.getElementById('editCenterLat').value = currentEditingCenter.latitude;
            document.getElementById('editCenterRadius').value = currentEditingCenter.radius;

            showModal('editCenterModal');
        }

        async function updateEmployee() {
            if (!currentEditingEmployee) return;

            const name = document.getElementById('editEmployeeName').value.trim();
            const phone = document.getElementById('editEmployeePhone').value.trim();
            const position = document.getElementById('editEmployeePosition').value.trim();
            const status = document.getElementById('editEmployeeStatus').value;
            const centerId = document.getElementById('editEmployeeCenter').value;

            if (!name || !phone) {
                showNotification('يرجى ملء الحقول المطلوبة', 'warning');
                return;
            }

            try {
                const { error } = await supabase
                    .from('employees')
                    .update({
                        name: name,
                        phone: phone,
                        position: position,
                        status: status,
                        center_id: centerId || null
                    })
                    .eq('id', currentEditingEmployee.id);

                if (error) throw error;

                closeModal('editEmployeeModal');
                await loadData();
                showNotification('تم تحديث بيانات الفرد بنجاح ✅', 'success');
            } catch (error) {
                console.error('Error updating employee:', error);
                showNotification('حدث خطأ في تحديث البيانات', 'error');
            }
        }

        async function updateCenter() {
            if (!currentEditingCenter) return;

            const name = document.getElementById('editCenterName').value.trim();
            const lng = parseFloat(document.getElementById('editCenterLng').value);
            const lat = parseFloat(document.getElementById('editCenterLat').value);
            const radius = parseInt(document.getElementById('editCenterRadius').value);

            if (!name || !lng || !lat || !radius) {
                showNotification('يرجى ملء جميع الحقول', 'warning');
                return;
            }

            try {
                const { error } = await supabase
                    .from('centers')
                    .update({
                        name: name,
                        longitude: lng,
                        latitude: lat,
                        radius: radius
                    })
                    .eq('id', currentEditingCenter.id);

                if (error) throw error;

                closeModal('editCenterModal');
                await loadData();
                showNotification('تم تحديث بيانات المركز بنجاح ✅', 'success');
            } catch (error) {
                console.error('Error updating center:', error);
                showNotification('حدث خطأ في تحديث البيانات', 'error');
            }
        }

        // CRUD Functions
        async function addCenter() {
            const name = document.getElementById('centerName').value.trim();
            const lng = parseFloat(document.getElementById('centerLng').value);
            const lat = parseFloat(document.getElementById('centerLat').value);
            const radius = parseInt(document.getElementById('centerRadius').value);

            if (!name || !lng || !lat || !radius) {
                showNotification('يرجى ملء جميع الحقول واختيار موقع على الخريطة', 'warning');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('centers')
                    .insert([{ name, longitude: lng, latitude: lat, radius }]);

                if (error) throw error;

                // Clear form
                document.getElementById('centerName').value = '';
                document.getElementById('centerLng').value = '';
                document.getElementById('centerLat').value = '';
                document.getElementById('centerRadius').value = '100';

                await loadData();
                showNotification('تم إضافة المركز بنجاح ✅', 'success');
            } catch (error) {
                console.error('Error adding center:', error);
                showNotification('حدث خطأ في إضافة المركز', 'error');
            }
        }

        async function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const password = document.getElementById('employeePassword').value.trim();
            const position = document.getElementById('employeePosition').value.trim();
            const centerId = document.getElementById('employeeCenter').value;

            if (!name || !phone || !password || !centerId) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'warning');
                return;
            }

            if (password.length < 6) {
                showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'warning');
                return;
            }

            try {
                const { data, error } = await supabase.rpc('add_employee', {
                    employee_name: name,
                    employee_phone: phone,
                    employee_password: password,
                    employee_position: position || 'فرد',
                    employee_center_id: parseInt(centerId)
                });

                if (error) throw error;

                const result = data;
                if (result.success) {
                    // Clear form
                    document.getElementById('employeeName').value = '';
                    document.getElementById('employeePhone').value = '';
                    document.getElementById('employeePassword').value = '';
                    document.getElementById('employeePosition').value = '';
                    document.getElementById('employeeCenter').value = '';

                    await loadData();
                    showNotification(`✅ تم إضافة الفرد بنجاح!`, 'success');
                } else {
                    showNotification('❌ ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding employee:', error);
                showNotification('حدث خطأ في إضافة الفرد: ' + error.message, 'error');
            }
        }

        // Load Data Functions
        async function loadData() {
            await Promise.all([
                loadCenters(),
                loadEmployees(),
                loadLogs(),
                updateStats(),
                refreshEmployeeLocations()
            ]);
            
            // Only update map markers if map is ready
            if (map && map.isStyleLoaded()) {
                updateMapMarkers();
            } else {
                // Wait for map to load then update
                if (map) {
                    map.on('load', updateMapMarkers);
                }
            }
        }

        async function loadCenters() {
            try {
                const { data: centers, error } = await supabase
                    .from('centers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allCenters = centers || [];
                
                const centersList = document.getElementById('centersList');
                const centerSelect = document.getElementById('employeeCenter');
                
                centersList.innerHTML = '';
                centerSelect.innerHTML = '<option value="">اختر المركز</option>';

                if (centers && centers.length > 0) {
                    centers.forEach(center => {
                        // Add to centers list with edit button
                        const centerDiv = document.createElement('div');
                        centerDiv.className = 'item-card';
                        centerDiv.innerHTML = `
                            <div class="item-info">
                                <strong>${center.name}</strong>
                                <small>نطاق: ${center.radius} متر • إحداثيات: ${center.latitude.toFixed(4)}, ${center.longitude.toFixed(4)}</small>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-success btn-small" onclick="editCenter(${center.id})">تعديل</button>
                                <button class="btn btn-danger btn-small" onclick="deleteCenter(${center.id})">حذف</button>
                            </div>
                        `;
                        centersList.appendChild(centerDiv);

                        // Add to select dropdown
                        const option = document.createElement('option');
                        option.value = center.id;
                        option.textContent = center.name;
                        centerSelect.appendChild(option);
                    });
                } else {
                    centersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد مراكز مضافة بعد</p>';
                }
            } catch (error) {
                console.error('Error loading centers:', error);
            }
        }

        async function loadEmployees() {
            try {
                const { data: employees, error } = await supabase
                    .from('employees')
                    .select(`*, centers (name)`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allEmployees = employees || [];
                
                const employeesList = document.getElementById('employeesList');
                employeesList.innerHTML = '';

                if (employees && employees.length > 0) {
                    employees.forEach(employee => {
                        const employeeDiv = document.createElement('div');
                        employeeDiv.className = `item-card employee-card ${employee.status}`;
                        employeeDiv.innerHTML = `
                            <div class="item-info">
                                <strong>${employee.name}</strong>
                                <small>${employee.position || 'موظف'} • 📱 ${employee.phone}</small><br>
                                <small>المركز: ${employee.centers?.name || 'غير محدد'}</small>
                            </div>
                            <div class="item-actions">
                                <span class="status-badge status-${employee.status}">
                                    ${employee.status === 'active' ? '🟢 نشط' : '🔴 غير نشط'}
                                </span>
                                <button class="btn btn-success btn-small" onclick="editEmployee(${employee.id})">تعديل</button>
                                <button class="btn btn-danger btn-small" onclick="deleteEmployee(${employee.id})">حذف</button>
                            </div>
                        `;
                        employeesList.appendChild(employeeDiv);
                    });
                } else {
                    employeesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد أفراد مضافين بعد</p>';
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        async function loadLogs() {
            try {
                const { data: logs, error } = await supabase
                    .from('logs')
                    .select(`*, employees (name), centers (name)`)
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) throw error;

                const logsContainer = document.getElementById('activityLogs');
                logsContainer.innerHTML = '';

                if (logs && logs.length > 0) {
                    logs.forEach(log => {
                        const logDiv = document.createElement('div');
                        logDiv.className = `log-entry ${log.action}`;
                        const date = new Date(log.created_at).toLocaleString('ar-EG');
                        logDiv.innerHTML = `
                            <strong>${log.employees?.name}</strong> - 
                            ${getActionText(log.action)} 
                            ${log.centers?.name || ''} 
                            <br><small>📅 ${date}</small>
                        `;
                        logsContainer.appendChild(logDiv);
                    });
                } else {
                    logsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد سجلات بعد</p>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function refreshEmployeeLocations() {
            try {
                const { data: latestLogs, error } = await supabase
                    .from('logs')
                    .select(`*, employees (id, name, status, phone), centers (name)`)
                    .not('latitude', 'is', null)
                    .not('longitude', 'is', null)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Group by employee and get latest location
                const employeeLocations = {};
                latestLogs.forEach(log => {
                    if (log.employees && !employeeLocations[log.employees.id]) {
                        employeeLocations[log.employees.id] = {
                            employee: log.employees,
                            center: log.centers,
                            location: {
                                latitude: log.latitude,
                                longitude: log.longitude,
                                action: log.action,
                                time: log.created_at
                            }
                        };
                    }
                });

                displayEmployeeLocations(employeeLocations);
                updateMapWithEmployees(employeeLocations);
            } catch (error) {
                console.error('Error loading employee locations:', error);
            }
        }

        function displayEmployeeLocations(employeeLocations) {
            const container = document.getElementById('employeeLocations');
            container.innerHTML = '';

            if (Object.keys(employeeLocations).length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">لا توجد مواقع حديثة</p>';
                return;
            }

            Object.values(employeeLocations).forEach(empData => {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'item-card employee-card';
                
                const timeDiff = getTimeDifference(empData.location.time);
                const actionText = getActionText(empData.location.action);
                const statusColor = empData.employee.status === 'active' ? '#28a745' : '#dc3545';
                const statusText = empData.employee.status === 'active' ? 'نشط' : 'غير نشط';

                locationDiv.innerHTML = `
                    <div class="item-info">
                        <strong>${empData.employee.name}</strong>
                        <small style="color: ${statusColor};">● ${statusText} • 📱 ${empData.employee.phone}</small><br>
                        <small>آخر موقع: ${actionText} - ${timeDiff}</small><br>
                        <small>المركز: ${empData.center?.name || 'غير محدد'}</small>
                    </div>
                    <div>
                        <button class="btn btn-small" onclick="focusOnEmployee(${empData.location.latitude}, ${empData.location.longitude}, '${empData.employee.name}')">
                            📍 عرض على الخريطة
                        </button>
                    </div>
                `;
                container.appendChild(locationDiv);
            });
        }

        async function updateStats() {
            try {
                const [employeesCount, activeCount, centersCount, logsCount] = await Promise.all([
                    supabase.from('employees').select('*', { count: 'exact', head: true }),
                    supabase.from('employees').select('*', { count: 'exact', head: true }).eq('status', 'active'),
                    supabase.from('centers').select('*', { count: 'exact', head: true }),
                    supabase.from('logs').select('*', { count: 'exact', head: true }).gte('created_at', new Date().toISOString().split('T')[0])
                ]);

                document.getElementById('totalEmployees').textContent = employeesCount.count || 0;
                document.getElementById('activeEmployees').textContent = activeCount.count || 0;
                document.getElementById('totalCenters').textContent = centersCount.count || 0;
                document.getElementById('todayLogs').textContent = logsCount.count || 0;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Map Functions (enhanced for Arabic support)
        async function updateMapMarkers() {
            if (!map || !map.isStyleLoaded()) {
                console.log('Map not ready yet...');
                return;
            }

            try {
                // Clear existing layers
                ['centers-layer', 'center-labels'].forEach(layerId => {
                    if (map.getLayer(layerId)) map.removeLayer(layerId);
                });
                if (map.getSource('centers')) map.removeSource('centers');

                const { data: centers, error } = await supabase.from('centers').select('*');
                if (error) throw error;

                if (centers && centers.length > 0) {
                    const geojsonData = {
                        type: 'FeatureCollection',
                        features: centers.map(center => ({
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [center.longitude, center.latitude]
                            },
                            properties: {
                                name: center.name,
                                radius: center.radius
                            }
                        }))
                    };

                    map.addSource('centers', {
                        type: 'geojson',
                        data: geojsonData
                    });

                    map.addLayer({
                        id: 'centers-layer',
                        type: 'circle',
                        source: 'centers',
                        paint: {
                            'circle-radius': 15,
                            'circle-color': '#667eea',
                            'circle-stroke-width': 3,
                            'circle-stroke-color': '#ffffff'
                        }
                    });

                    // Add Arabic labels with proper font support
                    map.addLayer({
                        id: 'center-labels',
                        type: 'symbol',
                        source: 'centers',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 2],
                            'text-anchor': 'top',
                            'text-size': 14,
                            'text-allow-overlap': true,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#2c3e50',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });

                    // Add popups with improved Arabic text rendering
                    map.on('click', 'centers-layer', (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { name, radius } = e.features[0].properties;

                        new mapboxgl.Popup({ 
                            closeOnClick: true,
                            className: 'arabic-popup'
                        })
                            .setLngLat(coordinates)
                            .setHTML(`
                                <div style="direction: rtl; text-align: right; font-family: 'Segoe UI', Arial, sans-serif;">
                                    <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">🏢 ${name}</h3>
                                    <p style="margin: 0; color: #7f8c8d; font-size: 14px;"><strong>نطاق العمل:</strong> ${radius} متر</p>
                                </div>
                            `)
                            .addTo(map);
                    });

                    // Fit map bounds
                    if (centers.length > 1) {
                        const bounds = new mapboxgl.LngLatBounds();
                        centers.forEach(center => {
                            bounds.extend([center.longitude, center.latitude]);
                        });
                        map.fitBounds(bounds, { padding: 50 });
                    }
                }
            } catch (error) {
                console.error('Error updating map markers:', error);
            }
        }

        function updateMapWithEmployees(employeeLocations) {
            if (!map || !map.isStyleLoaded()) {
                console.log('Map not ready for employee markers...');
                return;
            }

            // Clear existing employee layers
            ['employees-layer', 'employee-labels'].forEach(layerId => {
                if (map.getLayer(layerId)) map.removeLayer(layerId);
            });
            if (map.getSource('employees')) map.removeSource('employees');

            if (Object.keys(employeeLocations).length === 0) return;

            const employeesGeoJSON = {
                type: 'FeatureCollection',
                features: Object.values(employeeLocations).map(empData => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [empData.location.longitude, empData.location.latitude]
                    },
                    properties: {
                        name: empData.employee.name,
                        phone: empData.employee.phone,
                        status: empData.employee.status,
                        action: empData.location.action,
                        time: empData.location.time,
                        center: empData.center?.name || 'غير محدد'
                    }
                }))
            };

            map.addSource('employees', {
                type: 'geojson',
                data: employeesGeoJSON
            });

            map.addLayer({
                id: 'employees-layer',
                type: 'circle',
                source: 'employees',
                paint: {
                    'circle-radius': 12,
                    'circle-color': [
                        'case',
                        ['==', ['get', 'status'], 'active'],
                        '#28a745',
                        '#dc3545'
                    ],
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#ffffff'
                }
            });

            // Add Arabic employee labels with proper font support
            map.addLayer({
                id: 'employee-labels',
                type: 'symbol',
                source: 'employees',
                layout: {
                    'text-field': ['get', 'name'],
                    'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
                    'text-offset': [0, 2],
                    'text-anchor': 'top',
                    'text-size': 12,
                    'text-allow-overlap': true,
                    'text-ignore-placement': false
                },
                paint: {
                    'text-color': '#2c3e50',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 1
                }
            });

            // Add popups for employees with phone numbers and improved Arabic text
            map.on('click', 'employees-layer', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const properties = e.features[0].properties;
                const timeDiff = getTimeDifference(properties.time);

                new mapboxgl.Popup({ 
                    closeOnClick: true,
                    className: 'arabic-popup'
                })
                    .setLngLat(coordinates)
                    .setHTML(`
                        <div style="direction: rtl; text-align: right; font-family: 'Segoe UI', Arial, sans-serif;">
                            <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">${properties.name}</h3>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>📱 الهاتف:</strong> ${properties.phone}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>الحالة:</strong> ${properties.status === 'active' ? '🟢 نشط' : '🔴 غير نشط'}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>آخر نشاط:</strong> ${getActionText(properties.action)}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>التوقيت:</strong> ${timeDiff}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>المركز:</strong> ${properties.center}</p>
                        </div>
                    `)
                    .addTo(map);
            });

            // Change cursor on hover
            map.on('mouseenter', 'employees-layer', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'employees-layer', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        function focusOnEmployee(lat, lng, name) {
            if (!map) {
                showNotification('الخريطة غير محملة بعد', 'warning');
                return;
            }

            map.flyTo({
                center: [lng, lat],
                zoom: 16,
                duration: 2000
            });
            
            showNotification(`تم التركيز على موقع ${name}`, 'info');
        }

        // Helper Functions
        function getTimeDifference(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffInSeconds = Math.floor((now - time) / 1000);
            
            if (diffInSeconds < 60) {
                return 'منذ لحظات';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `منذ ${minutes} دقيقة`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `منذ ${hours} ساعة`;
            } else {
                const days = Math.floor(diffInSeconds / 86400);
                return `منذ ${days} يوم`;
            }
        }

        function getActionText(action) {
            const actions = {
                'in': '🟢 دخول',
                'out': '🔴 خروج',
                'move': '🟡 انتقال',
                'out_of_range': '⚠️ خارج النطاق'
            };
            return actions[action] || action;
        }

        function showNotification(message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => notif.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Delete Functions
        async function deleteCenter(centerId) {
            if (confirm('هل أنت متأكد من حذف هذا المركز؟ سيتم حذف جميع المرتبطين به.')) {
                try {
                    const { error } = await supabase
                        .from('centers')
                        .delete()
                        .eq('id', centerId);

                    if (error) throw error;
                    await loadData();
                    showNotification('تم حذف المركز بنجاح ✅', 'success');
                } catch (error) {
                    console.error('Error deleting center:', error);
                    showNotification('حدث خطأ في حذف المركز', 'error');
                }
            }
        }

        async function deleteEmployee(employeeId) {
            if (confirm('هل أنت متأكد من الحذف؟')) {
                try {
                    const { error } = await supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);

                    if (error) throw error;
                    await loadData();
                    showNotification('تم الحذف بنجاح ✅', 'success');
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showNotification('حدث خطأ في الحذف', 'error');
                }
            }
        }

        // Real-time Updates
        function setupRealTimeUpdates() {
            supabase
                .channel('logs_channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'logs' }, () => {
                    loadLogs();
                    updateStats();
                    refreshEmployeeLocations();
                })
                .subscribe();

            supabase
                .channel('employees_channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'employees' }, () => {
                    loadEmployees();
                    updateStats();
                })
                .subscribe();
        }

        // Auto refresh
        setInterval(() => {
            if (sessionData.isLoggedIn) {
                updateStats();
                refreshEmployeeLocations();
            }
        }, 15000);

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
    </script>
</body>
</html>
